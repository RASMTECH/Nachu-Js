<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register Learners with Firebase</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
        }
        .registration-form, .table-container {
            background: #90ee90;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
#reportGradeSelect {
  width: 100px;
}

      .form-group input, .form-group select, .form-group button {
    width: 25%;  /* reduced from 40% */
    padding: 8px;
    font-size: 15px;
    border: 1px solid #ccc;
    border-radius: 5px;
}
#recordMarksSection {
  background-color: #fff8dc; /* pale cream */
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #f0e0a0;
  margin-top: 20px;
}

        .form-group button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
        }
        .form-group button:hover {
            background-color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table th, table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        table th {
            background-color: #007bff;
            color: white;
        }
        table img {
            max-width: 50px;
            border-radius: 50%;
        }
  .filter-bar {
  display: flex;
  gap: 5px;
  margin-bottom: 20px;
}

.filter-bar input,
.filter-bar select {
  padding: 5px;
  font-size: 16px;
}

#reportGradeSelect {
  width: 200px; /* Or whatever fixed width you prefer */
  flex: 0 0 auto;
}
  
        .print-button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        .print-button:hover {
            background-color: #218838;
        }

        /* Print-specific styles */
        @media print {
            .filter-bar, .form-group button, .print-button {
                display: none;
            }

            table {
                border: 1px solid #000;
            }

            table th, table td {
                border: 1px solid #000;
            }

            table th {
                background-color: black;
                color: white;
            }

            table td {
                background-color: #f2f2f2;
            }
        }
.modal {
  display: none; /* Hidden by default */
  position: fixed;
  z-index: 10;
  top: 50%; /* Position the modal at 50% of the viewport height */
  left: 50%; /* Position the modal at 50% of the viewport width */
  transform: translate(-50%, -50%); /* Offset by 50% of the modal's width and height to truly center */
  width: 60%;
  max-height: 100%; /* Adjust height to prevent overflow on smaller screens */
  overflow: auto; /* Add scroll if content overflows */
  background-color: rgba(0, 0, 0, 0.5); /* Background overlay */
  padding: 20px; /* Add some padding inside the modal */
  border-radius: 10px; /* Rounded corners for modern look */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); /* Subtle shadow for elevation */
}

.modal-content {
  background-color: #fff;
  margin: 5% auto;
  padding: 30px 30px;
  border-radius: 10px;
  width: 90%;
  max-width: 400px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.close-btn {
  float: right;
  font-size: 24px;
  font-weight: bold;
  color: #aaa;
  cursor: pointer;
}

.close-btn:hover {
  color: #000;
}

.modal-title {
  text-align: center;
  margin-bottom: 25px;
  font-size: 1.5rem;
}

.form-section {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  margin-bottom: 5px;
  font-weight: 500;
}

.form-group input {
  padding: 8px 12px;
  border-radius: 5px;
  border: 1px solid #ccc;
}

.form-actions {
  text-align: center;
  margin-top: 20px;
}

.print-button {
  background-color: #2c3e50;
  color: white;
  padding: 10px 16px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
}

.print-button:hover {
  background-color: #1a252f;
}

.report-button {
  padding: 10px;
  font-size: 14px;
  border: none;
  color: white;
  cursor: pointer;
  border-radius: 5px;
  text-align: left;
}

.report-button i {
  margin-right: 8px;
}

 .report-buttons-box {
  display: flex;
  flex-direction: column; /* Keeps buttons aligned vertically */
  align-items: flex-start; /* Aligns buttons to the left for natural width */
  gap: 10px; /* Space between buttons */
  padding: 10px;
  background: #f9f9f9;
  max-width: 45%; /* Allow buttons to dynamically resize within the container */
  border: 1px solid #ccc;
  border-radius: 10px;
  margin-top: 15px;
}

.report-button {
  display: inline-block; /* Ensures button width adapts to content */
  padding: 10px 15px; /* Adjust for height and inner spacing */
  font-size: 14px;
  font-weight: bold;
  color: white;
  border: none;
  border-radius: 5px;
  text-align: center;
  cursor: pointer;
  white-space: nowrap; /* Prevent text wrapping */
  width: auto; /* Let buttons size dynamically */
}

.report-button.red { background-color: #f44336; }
.report-button.blue { background-color: #2196f3; }
.report-button.green { background-color: #4caf50; }
.report-button.purple { background-color: #9c27b0; }
.report-button.orange { background-color: #ff9800; }
.report-button.teal { background-color: #009688; }
.report-button.gray { background-color: #607d8b; }

.report-button i {
  margin-right: 8px; /* Space between icon and text */
}


  /* Optional: Space between buttons */
  .report-button + .report-button {
    margin-left: 10px; /* Add spacing between buttons */
  }
/* LOGIN FORM STYLES */
#loginSection, #resetPasswordSection {
  max-width: 300px;
  margin: 60px auto;
  padding: 30px 25px;
  background-color: #ffffff;
  border-radius: 10px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  font-family: 'Segoe UI', sans-serif;
}

#loginSection h1, #resetPasswordSection h2 {
  font-size: 24px;
  margin-bottom: 10px;
  color: #333;
}

#loginSection p {
  margin-bottom: 20px;
  font-size: 14px;
  color: #c0392b;
}

#marksCountBadge {
  display: inline-block;
  padding: 6px 14px;
  border-radius: 20px;        /* Rounded pill shape */
  background-color: #28a745;  /* Bootstrap's green */
  color: white;
  font-weight: 600;
  font-size: 0.9rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  user-select: none;
  margin-top: 8px;
}

#loginForm input,
#resetPasswordForm input {
  width: 80%;
  padding: 12px 10px;
  margin-bottom: 15px;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 15px;
  transition: border-color 0.3s ease;
}

#loginForm input:focus,
#resetPasswordForm input:focus {
  border-color: #007bff;
  outline: none;
}

.btn-login,
#resetPasswordForm button {
  width: 80%;
  padding: 12px;
  background-color: #007bff;
  border: none;
  color: white;
  border-radius: 6px;
  font-size: 16px;
  cursor: pointer;
  transition: background-color 0.25s ease;
}

.btn-login:hover,
#resetPasswordForm button:hover {
  background-color: #0056b3;
}

button[onclick^="show"] {
  margin-top: 10px;
  background: none;
  border: none;
  color: #007bff;
  cursor: pointer;
  text-decoration: underline;
}

#loginError,
#resetError,
#resetSuccess {
  font-size: 14px;
  margin-top: 10px;
}
/* General Print Styling */
@media print {
    /* Prevent content from breaking across pages */
    .no-break {
        page-break-inside: avoid;
    }

    /* Adjust margins for printed pages */
    body {
        margin: 0;
        padding: 10px;
    }

    /* Ensure the layout fits within the page width */
    .container {
        width: 100%;
        max-width: 100%;
    }

    /* Optional: Hide elements like buttons or navigation during print */
    .no-print {
        display: none;
    }

    /* Tables: Add borders for clarity */
    table {
        border-collapse: collapse;
        width: 100%;
    }
    table th, table td {
        border: 1px solid #000;
        padding: 8px;
    }
}
.learners-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.learners-table th, 
.learners-table td {
  border: 1px solid #000;
  padding: 8px;
  text-align: left;
}

.learners-table th {
  background-color: #f0f0f0;
  font-weight: bold;
  color: #000;
}

.learners-table tr:nth-child(even) {
  background-color: #fafafa;
}

.learners-table tr:hover {
  background-color: #e0e0e0;
}
.marks-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

.marks-table th, 
.marks-table td {
  border: 1px solid #000;
  padding: 8px;
  text-align: left;
}

.marks-table th {
  background-color: #f0f0f0;
  font-weight: bold;
  color: #000;
}

.marks-table tr:nth-child(even) {
  background-color: #fafafa;
}

.marks-table tr:hover {
  background-color: #e0e0e0;
}
.filter-bar input,
.filter-bar select,
.filter-bar button {
  height: 32px;
  padding: 4px 8px;
  font-size: 14px;
  border-radius: 4px;
  border: 1px solid #ccc;
  margin-right: 8px;
}

#marksExamPeriodSelect {
  width: 220px;
}
.toast {
  position: fixed;
  bottom: 30px;
  right: 30px;
  min-width: 250px;
  padding: 16px;
  background-color: #323232;
  color: #fff;
  border-radius: 6px;
  opacity: 0;
  transition: opacity 0.5s ease, bottom 0.5s ease;
  z-index: 9999;
  font-size: 15px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.toast.show {
  opacity: 1;
  bottom: 50px;
}

.toast.success {
  background-color: #4CAF50;
}

.toast.error {
  background-color: #F44336;
}

.toast.info {
  background-color: #2196F3;
}
#marksInputs {
  display: grid;
  grid-template-columns: 1fr 1fr; /* two equal columns */
  gap: 15px;
}

.form-group {
  display: flex;
  flex-direction: column;
}

.form-group label {
  font-weight: bold;
  margin-bottom: 5px;
}

.form-group input {
  padding: 8px;
  border: 1px solid #ccc;
  border-radius: 4px;
}
@media (max-width: 600px) {
  #marksInputs {
    grid-template-columns: 1fr;
  }
}

    </style>
</head>
<body>


<!-- LOGIN SECTION -->
<div id="loginSection" style="display: block; text-align: center; margin-top: 50px;">
    <div class="logo">
        <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" class="logo-img" style="width: 100px;">
    </div>
    <h1>RASM School Management System</h1>
    <p style="color: red; font-weight: bold;">NACHU JUNIOR  SCHOOL </p>
    <form id="loginForm">
        <input type="text" id="username" placeholder="Username" required><br><br>
        <input type="password" id="password" placeholder="Password" required><br><br>
        <button type="submit" class="btn-login">
            <span class="material-icons">login</span> Login
        </button>
    </form>
    <div id="loginError" style="color: red; display: none;">Invalid username or password</div>
    <br>
    <button onclick="showResetPasswordForm()">Forgot Password?</button>
</div>

<!-- MAIN CONTENT SECTION -->
<div id="mainContent" style="display: none;">
 
<!-- Learners Database Master Toggle -->
<div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px;">
  <button 
    type="button" 
    id="masterToggleBtn"
    style="
      background-color: #673AB7; 
      color: white; 
      height: 50px; 
      padding: 0 20px; 
      border: none; 
      border-radius: 4px; 
      font-size: 1rem; 
      display: inline-flex; 
      align-items: center; 
      cursor: pointer;
    "
  >
    <i class="fas fa-database" style="margin-right: 8px; font-size: 1.2em;"></i>
    Learners Database
  </button>

  <div 
    id="learnersButtons" 
    style="display: none; flex-direction: column; gap: 8px; width: 100%;"
  >
    <button 
      type="button" 
      id="toggleTableBtn"
      style="
        background-color: #2196F3; 
        color: white; 
        height: 48px; 
        padding: 0 16px; 
        border: none; 
        border-radius: 4px; 
        font-size: 1rem; 
        display: inline-flex; 
        align-items: center; 
        cursor: pointer;
      "
    >
      <i class="fas fa-list" style="margin-right: 6px;"></i>
      Registered Learners
    </button>

    <button 
      type="button" 
      id="toggleFormBtn"
      style="
        background-color: #4CAF50; 
        color: white; 
        height: 50px; 
        padding: 0 20px; 
        border: none; 
        border-radius: 4px; 
        font-size: 1rem; 
        display: inline-flex; 
        align-items: center; 
        cursor: pointer;
      "
    >
      <i class="fas fa-user-plus" style="margin-right: 8px;"></i>
      Register Learner
    </button>
  </div>
</div>

<!-- Exam & Marks Controls Master Toggle -->
<div style="display: flex; flex-direction: column; align-items: flex-start; gap: 8px; margin-top: 20px;">
  <button 
    type="button" 
    id="masterReportsBtn"
    style="
      background-color: #9C27B0;
      color: white;
      height: 48px;
      padding: 0 20px;
      border: none;
      border-radius: 4px;
      font-size: 1rem;
      display: inline-flex;
      align-items: center;
      cursor: pointer;
    "
  >
    <i class="fas fa-chart-bar" style="margin-right: 8px;"></i>
    <span class="btn-label">Exam & Marks Controls</span>
  </button>
</div>

  <div 
    id="reportsControls" 
    style="display: none; flex-direction: column; gap: 8px; width: 100%;"
  >
    <button class="print-button" id="togglePerformanceReportsBtn" 
      style="
        background-color: #03A9F4;
        color: white;
        height: 44px;
        padding: 0 16px;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
      "
    >
      <i class="fas fa-chevron-down" style="margin-right: 6px;"></i>
      Exam Reports
    </button>

    <button class="print-button" id="toggleMarksSectionBtn"
      style="
        background-color:#03A9F4;
        color: white;
        height: 44px;
        padding: 0 16px;
        border: none;
        border-radius: 4px;
        font-size: 1rem;
        display: inline-flex;
        align-items: center;
        cursor: pointer;
      "
    >
      <i class="fas fa-chevron-down" style="margin-right: 6px;"></i>
      Record Marks
    </button>
  <!-- Button to Show/Hide Fee Management Menu -->
  <button onclick="toggleFeeActionsMenu()" style="background-color: #d32f2f; color: purple; border: none; padding: 10px 10px; font-size: 16px; cursor: pointer; border-radius: 5px; margin-bottom: 10px;">
    <i class="fas fa-cogs"></i> Manage Fees
  </button>

  </div>
</div>

<!-- Wrapped form, hidden by default -->
<div id="registrationContainer" style="display: none; margin-top: 20px; max-width: 450px; margin: auto; background-color: #8BC34A; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
  <h2 style="color: white; background-color: gold; padding: 10px 12px; border-radius: 4px; text-align: center;">
    Register Learner
  </h2>

  <form id="learnerForm">
    <label>Name:</label>
    <input type="text" id="name" placeholder="Enter name" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <label>Gender:</label>
    <select id="gender" required style="width: 100%; padding: 8px; margin: 6px 0;">
      <option value="">Select Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select><br>

    <label>Grade:</label>
    <input type="text" id="grade" placeholder="Enter grade e.g. Grade 9A" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <label>Age:</label>
    <input type="number" id="age" placeholder="Enter age" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <label>Parent Name:</label>
    <input type="text" id="parentName" placeholder="Enter parent name" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <label>Parent Phone:</label>
    <input type="tel" id="parentPhone" placeholder="Enter phone number" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <label>Birth Certificate No:</label>
    <input type="text" id="birthCert" placeholder="Enter birth certificate no" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <label>Admission Number:</label>
    <input type="text" id="admissionNo" placeholder="Enter admission number" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <label>Learner Photo:</label>
    <input type="file" id="photo" accept="image/*" required style="width: 100%; padding: 8px; margin: 6px 0;"><br>

    <button type="button" id="registerButton"
      style="padding: 10px 14px; background: #3F51B5; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 12px; width: 100%;">
      <i class="fas fa-user-plus" style="margin-right: 6px;"></i> Register Learner
    </button>
  </form>
</div>

  </div>
<div id="tableContainer" style="display: none; margin-top: 20px;">
  <h2>Registered Learners</h2>

  <!-- Filter Bar -->
  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="Search by Name or Admission Number">
    <select id="filterGrade">
      <option value="">Filter by Grade</option>
    </select>
    <select id="filterGender">
      <option value="">Filter by Gender</option>
      <option value="Male">Male</option>
      <option value="Female">Female</option>
    </select>
  </div>

  <!-- Action Buttons -->
  <div class="action-buttons" style="margin-top: 15px;">
    <button class="print-button" id="printButton">
      <i class="fas fa-print"></i> Print Filtered Learners
    </button>
    <button class="print-button" id="printGroupedByGenderButton">
      <i class="fas fa-venus-mars"></i> Print Grouped by Gender
    </button>
    <button class="print-button" id="generateParentsListBtn">
      <i class="fas fa-users"></i> Generate Parents List
    </button>
    <button class="print-button" id="toggleClassListSectionBtn">
      <i class="fas fa-chevron-down"></i> Class List Generator
    </button>
<button class="print-button" onclick="promoteLearners()">
  <i class="fas fa-level-up-alt"></i> Promote Learners
</button>

  </div>

  <!-- Learners Table -->
  <table class="learners-table" style="margin-top: 20px;">
    <thead>
      <tr>
        <th>No.</th>
        <th>Photo</th>
        <th>Name</th>
        <th>Gender</th>
        <th>Grade</th>
        <th>Age</th>
        <th>Parent Name</th>
        <th>Parent Phone No</th>
        <th>Birth Certificate No</th>
        <th>Admission Number</th>
        <th>Photo Edit</th>
       <th>Action</th>
      </tr>
    </thead>
    <tbody id="learnersList"></tbody>
  </table>

  <!-- Class List Generator Section -->
  <div id="classListSection" class="table-container" style="display: none; margin-top: 20px;">
    <h2 style="background-color: #ffff00; padding: 8px 16px; border-radius: 6px; display: inline-block;">Generate Class List per Grade</h2>

    <div class="filter-bar" style="margin: 15px 0;">
      <select id="classListGradeSelect">
        <option value="">Select Grade</option>
      </select>
      <button class="print-button" id="generateClassListBtn">
        <i class="fas fa-list"></i> Generate Class List
      </button>
    </div>

    <div id="classListOutput"></div>
  </div>
</div>

<!-- Modal -->
<div id="learnerModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3>Learner Details</h3>
    <div id="modalDetails"></div>
  </div>
</div>

<!-- Record Marks Section -->
<div id="recordMarksSection" style="max-width: 400px; margin: auto; display: none; background-color: #8BC34A; padding: 15px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1);">
  <h2 style="color: white; background-color: gold; padding: 8px 8px; border-radius: 3px; text-align: center;">
    Record Learner Marks
  </h2>

<form id="marksForm">
  <label><strong>Grade:</strong></label>
  <select id="gradeSelect" required 
    style="width: 100%; padding: 6px; margin: 6px 0; background-color: #fff8c6; border: 1px solid #ccc; border-radius: 4px;">
    <option value="">Select Grade</option>
  </select><br>

  <label><strong>Learner:</strong></label>
  <select id="learnerSelect" required 
    style="width: 100%; padding: 6px; margin: 6px 0; background-color: #fff8c6; border: 1px solid #ccc; border-radius: 4px;">
    <option value="">Select Learner</option>
  </select><br>

  <!-- Exam Period Dropdown -->
  <div class="form-group">
    <label for="examPeriod"><strong>Select Period</strong></label>
    <select id="examPeriod" required
      style="width: 100%; padding: 6px; margin: 6px 0; background-color: #fff8c6; border: 1px solid #ccc; border-radius: 4px;">
  

        <option value="">-- Select Period --</option>
    <option value="2024, Term 1, Opener Exam">2024, Term 1, Opener Exam</option>
<option value="2024, Term 1, Midterm Exam">2024, Term 1, Midterm Exam</option>
<option value="2024, Term 1, End Term Exam">2024, Term 1, End Term Exam</option>
<option value="2024, Term 2, Opener Exam">2024, Term 2, Opener Exam</option>
<option value="2024, Term 2, Midterm Exam">2024, Term 2, Midterm Exam</option>
<option value="2024, Term 2, End Term Exam">2024, Term 2, End Term Exam</option>
<option value="2024, Term 3, Opener Exam">2024, Term 3, Opener Exam</option>
<option value="2024, Term 3, Midterm Exam">2024, Term 3, Midterm Exam</option>
<option value="2024, Term 3, End Term Exam">2024, Term 3, End Term Exam</option>

<option value="2025, Term 1, Opener Exam">2025, Term 1, Opener Exam</option>
<option value="2025, Term 1, Midterm Exam">2025, Term 1, Midterm Exam</option>
<option value="2025, Term 1, End Term Exam">2025, Term 1, End Term Exam</option>
<option value="2025, Term 2, Opener Exam">2025, Term 2, Opener Exam</option>
<option value="2025, Term 2, Midterm Exam">2025, Term 2, Midterm Exam</option>
<option value="2025, Term 2, End Term Exam">2025, Term 2, End Term Exam</option>
<option value="2025, Term 3, Opener Exam">2025, Term 3, Opener Exam</option>
<option value="2025, Term 3, Midterm Exam">2025, Term 3, Midterm Exam</option>
<option value="2025, Term 3, End Term Exam">2025, Term 3, End Term Exam</option>

<option value="2026, Term 1, Opener Exam">2026, Term 1, Opener Exam</option>
<option value="2026, Term 1, Midterm Exam">2026, Term 1, Midterm Exam</option>
<option value="2026, Term 1, End Term Exam">2026, Term 1, End Term Exam</option>
<option value="2026, Term 2, Opener Exam">2026, Term 2, Opener Exam</option>
<option value="2026, Term 2, Midterm Exam">2026, Term 2, Midterm Exam</option>
<option value="2026, Term 2, End Term Exam">2026, Term 2, End Term Exam</option>
<option value="2026, Term 3, Opener Exam">2026, Term 3, Opener Exam</option>
<option value="2026, Term 3, Midterm Exam">2026, Term 3, Midterm Exam</option>
<option value="2026, Term 3, End Term Exam">2026, Term 3, End Term Exam</option>

<option value="2027, Term 1, Opener Exam">2027, Term 1, Opener Exam</option>
<option value="2027, Term 1, Midterm Exam">2027, Term 1, Midterm Exam</option>
<option value="2027, Term 1, End Term Exam">2027, Term 1, End Term Exam</option>
<option value="2027, Term 2, Opener Exam">2027, Term 2, Opener Exam</option>
<option value="2027, Term 2, Midterm Exam">2027, Term 2, Midterm Exam</option>
<option value="2027, Term 2, End Term Exam">2027, Term 2, End Term Exam</option>
<option value="2027, Term 3, Opener Exam">2027, Term 3, Opener Exam</option>
<option value="2027, Term 3, Midterm Exam">2027, Term 3, Midterm Exam</option>
<option value="2027, Term 3, End Term Exam">2027, Term 3, End Term Exam</option>
<!-- 2028 -->
<option value="2028, Term 1, Opener Exam">2028, Term 1, Opener Exam</option>
<option value="2028, Term 1, Midterm Exam">2028, Term 1, Midterm Exam</option>
<option value="2028, Term 1, End Term Exam">2028, Term 1, End Term Exam</option>
<option value="2028, Term 2, Opener Exam">2028, Term 2, Opener Exam</option>
<option value="2028, Term 2, Midterm Exam">2028, Term 2, Midterm Exam</option>
<option value="2028, Term 2, End Term Exam">2028, Term 2, End Term Exam</option>
<option value="2028, Term 3, Opener Exam">2028, Term 3, Opener Exam</option>
<option value="2028, Term 3, Midterm Exam">2028, Term 3, Midterm Exam</option>
<option value="2028, Term 3, End Term Exam">2028, Term 3, End Term Exam</option>

<!-- 2029 -->
<option value="2029, Term 1, Opener Exam">2029, Term 1, Opener Exam</option>
<option value="2029, Term 1, Midterm Exam">2029, Term 1, Midterm Exam</option>
<option value="2029, Term 1, End Term Exam">2029, Term 1, End Term Exam</option>
<option value="2029, Term 2, Opener Exam">2029, Term 2, Opener Exam</option>
<option value="2029, Term 2, Midterm Exam">2029, Term 2, Midterm Exam</option>
<option value="2029, Term 2, End Term Exam">2029, Term 2, End Term Exam</option>
<option value="2029, Term 3, Opener Exam">2029, Term 3, Opener Exam</option>
<option value="2029, Term 3, Midterm Exam">2029, Term 3, Midterm Exam</option>
<option value="2029, Term 3, End Term Exam">2029, Term 3, End Term Exam</option>

<!-- 2030 -->
<option value="2030, Term 1, Opener Exam">2030, Term 1, Opener Exam</option>
<option value="2030, Term 1, Midterm Exam">2030, Term 1, Midterm Exam</option>
<option value="2030, Term 1, End Term Exam">2030, Term 1, End Term Exam</option>
<option value="2030, Term 2, Opener Exam">2030, Term 2, Opener Exam</option>
<option value="2030, Term 2, Midterm Exam">2030, Term 2, Midterm Exam</option>
<option value="2030, Term 2, End Term Exam">2030, Term 2, End Term Exam</option>
<option value="2030, Term 3, Opener Exam">2030, Term 3, Opener Exam</option>
<option value="2030, Term 3, Midterm Exam">2030, Term 3, Midterm Exam</option>
<option value="2030, Term 3, End Term Exam">2030, Term 3, End Term Exam</option>

<!-- 2031 -->
<option value="2031, Term 1, Opener Exam">2031, Term 1, Opener Exam</option>
<option value="2031, Term 1, Midterm Exam">2031, Term 1, Midterm Exam</option>
<option value="2031, Term 1, End Term Exam">2031, Term 1, End Term Exam</option>
<option value="2031, Term 2, Opener Exam">2031, Term 2, Opener Exam</option>
<option value="2031, Term 2, Midterm Exam">2031, Term 2, Midterm Exam</option>
<option value="2031, Term 2, End Term Exam">2031, Term 2, End Term Exam</option>
<option value="2031, Term 3, Opener Exam">2031, Term 3, Opener Exam</option>
<option value="2031, Term 3, Midterm Exam">2031, Term 3, Midterm Exam</option>
<option value="2031, Term 3, End Term Exam">2031, Term 3, End Term Exam</option>

<!-- 2032 -->
<option value="2032, Term 1, Opener Exam">2032, Term 1, Opener Exam</option>
<option value="2032, Term 1, Midterm Exam">2032, Term 1, Midterm Exam</option>
<option value="2032, Term 1, End Term Exam">2032, Term 1, End Term Exam</option>
<option value="2032, Term 2, Opener Exam">2032, Term 2, Opener Exam</option>
<option value="2032, Term 2, Midterm Exam">2032, Term 2, Midterm Exam</option>
<option value="2032, Term 2, End Term Exam">2032, Term 2, End Term Exam</option>
<option value="2032, Term 3, Opener Exam">2032, Term 3, Opener Exam</option>
<option value="2032, Term 3, Midterm Exam">2032, Term 3, Midterm Exam</option>
<option value="2032, Term 3, End Term Exam">2032, Term 3, End Term Exam</option>
<!-- 2033 -->
<option value="2033, Term 1, Opener Exam">2033, Term 1, Opener Exam</option>
<option value="2033, Term 1, Midterm Exam">2033, Term 1, Midterm Exam</option>
<option value="2033, Term 1, End Term Exam">2033, Term 1, End Term Exam</option>
<option value="2033, Term 2, Opener Exam">2033, Term 2, Opener Exam</option>
<option value="2033, Term 2, Midterm Exam">2033, Term 2, Midterm Exam</option>
<option value="2033, Term 2, End Term Exam">2033, Term 2, End Term Exam</option>
<option value="2033, Term 3, Opener Exam">2033, Term 3, Opener Exam</option>
<option value="2033, Term 3, Midterm Exam">2033, Term 3, Midterm Exam</option>
<option value="2033, Term 3, End Term Exam">2033, Term 3, End Term Exam</option>

<!-- 2034 -->
<option value="2034, Term 1, Opener Exam">2034, Term 1, Opener Exam</option>
<option value="2034, Term 1, Midterm Exam">2034, Term 1, Midterm Exam</option>
<option value="2034, Term 1, End Term Exam">2034, Term 1, End Term Exam</option>
<option value="2034, Term 2, Opener Exam">2034, Term 2, Opener Exam</option>
<option value="2034, Term 2, Midterm Exam">2034, Term 2, Midterm Exam</option>
<option value="2034, Term 2, End Term Exam">2034, Term 2, End Term Exam</option>
<option value="2034, Term 3, Opener Exam">2034, Term 3, Opener Exam</option>
<option value="2034, Term 3, Midterm Exam">2034, Term 3, Midterm Exam</option>
<option value="2034, Term 3, End Term Exam">2034, Term 3, End Term Exam</option>

<!-- 2035 -->
<option value="2035, Term 1, Opener Exam">2035, Term 1, Opener Exam</option>
<option value="2035, Term 1, Midterm Exam">2035, Term 1, Midterm Exam</option>
<option value="2035, Term 1, End Term Exam">2035, Term 1, End Term Exam</option>
<option value="2035, Term 2, Opener Exam">2035, Term 2, Opener Exam</option>
<option value="2035, Term 2, Midterm Exam">2035, Term 2, Midterm Exam</option>
<option value="2035, Term 2, End Term Exam">2035, Term 2, End Term Exam</option>
<option value="2035, Term 3, Opener Exam">2035, Term 3, Opener Exam</option>
<option value="2035, Term 3, Midterm Exam">2035, Term 3, Midterm Exam</option>
<option value="2035, Term 3, End Term Exam">2035, Term 3, End Term Exam</option>

<!-- 2036 -->
<option value="2036, Term 1, Opener Exam">2036, Term 1, Opener Exam</option>
<option value="2036, Term 1, Midterm Exam">2036, Term 1, Midterm Exam</option>
<option value="2036, Term 1, End Term Exam">2036, Term 1, End Term Exam</option>
<option value="2036, Term 2, Opener Exam">2036, Term 2, Opener Exam</option>
<option value="2036, Term 2, Midterm Exam">2036, Term 2, Midterm Exam</option>
<option value="2036, Term 2, End Term Exam">2036, Term 2, End Term Exam</option>
<option value="2036, Term 3, Opener Exam">2036, Term 3, Opener Exam</option>
<option value="2036, Term 3, Midterm Exam">2036, Term 3, Midterm Exam</option>
<option value="2036, Term 3, End Term Exam">2036, Term 3, End Term Exam</option>

<!-- 2037 -->
<option value="2037, Term 1, Opener Exam">2037, Term 1, Opener Exam</option>
<option value="2037, Term 1, Midterm Exam">2037, Term 1, Midterm Exam</option>
<option value="2037, Term 1, End Term Exam">2037, Term 1, End Term Exam</option>
<option value="2037, Term 2, Opener Exam">2037, Term 2, Opener Exam</option>
<option value="2037, Term 2, Midterm Exam">2037, Term 2, Midterm Exam</option>
<option value="2037, Term 2, End Term Exam">2037, Term 2, End Term Exam</option>
<option value="2037, Term 3, Opener Exam">2037, Term 3, Opener Exam</option>
<option value="2037, Term 3, Midterm Exam">2037, Term 3, Midterm Exam</option>
<option value="2037, Term 3, End Term Exam">2037, Term 3, End Term Exam</option>

<option value="2038, Term 1, Opener Exam">2038, Term 1, Opener Exam</option>
<option value="2038, Term 1, Midterm Exam">2038, Term 1, Midterm Exam</option>
<option value="2038, Term 1, End Term Exam">2038, Term 1, End Term Exam</option>
<option value="2038, Term 2, Opener Exam">2038, Term 2, Opener Exam</option>
<option value="2038, Term 2, Midterm Exam">2038, Term 2, Midterm Exam</option>
<option value="2038, Term 2, End Term Exam">2038, Term 2, End Term Exam</option>
<option value="2038, Term 3, Opener Exam">2038, Term 3, Opener Exam</option>
<option value="2038, Term 3, Midterm Exam">2038, Term 3, Midterm Exam</option>
<option value="2038, Term 3, End Term Exam">2038, Term 3, End Term Exam</option>


<option value="2039, Term 1, Opener Exam">2039, Term 1, Opener Exam</option>
<option value="2039, Term 1, Midterm Exam">2039, Term 1, Midterm Exam</option>
<option value="2039, Term 1, End Term Exam">2039, Term 1, End Term Exam</option>
<option value="2039, Term 2, Opener Exam">2039, Term 2, Opener Exam</option>
<option value="2039, Term 2, Midterm Exam">2039, Term 2, Midterm Exam</option>
<option value="2039, Term 2, End Term Exam">2039, Term 2, End Term Exam</option>
<option value="2039, Term 3, Opener Exam">2039, Term 3, Opener Exam</option>
<option value="2039, Term 3, Midterm Exam">2039, Term 3, Midterm Exam</option>
<option value="2039, Term 3, End Term Exam">2039, Term 3, End Term Exam</option>

<option value="2040, Term 1, Opener Exam">2040, Term 1, Opener Exam</option>
<option value="2040, Term 1, Midterm Exam">2040, Term 1, Midterm Exam</option>
<option value="2040, Term 1, End Term Exam">2040, Term 1, End Term Exam</option>
<option value="2040, Term 2, Opener Exam">2040, Term 2, Opener Exam</option>
<option value="2040, Term 2, Midterm Exam">2040, Term 2, Midterm Exam</option>
<option value="2040, Term 2, End Term Exam">2040, Term 2, End Term Exam</option>
<option value="2040, Term 3, Opener Exam">2040, Term 3, Opener Exam</option>
<option value="2040, Term 3, Midterm Exam">2040, Term 3, Midterm Exam</option>
<option value="2040, Term 3, End Term Exam">2040, Term 3, End Term Exam</option>

      </select>
    </div>

  <div id="marksInputs">
  <div class="form-group"><label>Eng</label><input type="number" id="eng" required></div>
  <div class="form-group"><label>Math</label><input type="number" id="math" required></div>
  <div class="form-group"><label>Pre-Tech</label><input type="number" id="preTech" required></div>
  <div class="form-group"><label>Kiswahili</label><input type="number" id="kiswahili" required></div>
  <div class="form-group"><label>Science</label><input type="number" id="science" required></div>
  <div class="form-group"><label>Social</label><input type="number" id="social" required></div>
  <div class="form-group"><label>Agriculture</label><input type="number" id="agriculture" required></div>
  <div class="form-group"><label>CRE</label><input type="number" id="cre" required></div>
  <div class="form-group"><label>Creative Art</label><input type="number" id="creativeArt" required></div>
</div>


    <div class="form-group">
      <button type="button" id="saveMarksButton">
        <i class="fas fa-save"></i> Save Marks
      </button>
<div id="marksCountBadge" style="margin: 8px 0; font-weight: bold; color: #333;"></div>
    </div>
  </form>
</div>


<!-- Marks Display Section -->
<div id="marksSection" style="display: none; margin-top: 20px;">
  <h2 style="background-color: #ffff00; padding: 8px 16px; border-radius: 6px; display: inline-block;">
    Recorded Learner Marks
  </h2>

  <div class="filter-bar" style="display: flex; flex-wrap: wrap; gap: 16px; margin-top: 20px; align-items: flex-end;">

  <!-- Search Input -->
<div class="form-group">
  <label for="searchMarksInput"><strong>Search by Name or Admission Number</strong></label>
  <input 
    type="text" 
    id="searchMarksInput" 
    placeholder="Enter learner name or admission number"
    style="width: 220px; background-color: #fff8c6; border: 1px solid #ccc; padding: 6px; border-radius: 4px;"
  >
</div>

<!-- Filter by Grade -->
<div class="form-group">
  <label for="filterMarksGrade"><strong>Filter by Grade</strong></label>
  <select id="filterMarksGrade" 
    style="width: 220px; background-color: #fff8c6; border: 1px solid #ccc; padding: 6px; border-radius: 4px;">
    <option value="">-- Select Grade --</option>
  </select>
</div>
 <!-- Filter by Exam Period -->
<div class="form-group">
  <label for="marksExamPeriodSelect"><strong>Filter by Exam Period</strong></label>
  <select id="marksExamPeriodSelect" 
    style="width: 220px; background-color: #fff8c6; border: 1px solid #ccc; padding: 6px; border-radius: 4px;">
    <option value="">-- Select Exam Period --</option>

        <option value="">-- Select Exam Period --</option>
 <option value="2024, Term 1, Opener Exam">2024, Term 1, Opener Exam</option>
<option value="2024, Term 1, Midterm Exam">2024, Term 1, Midterm Exam</option>
<option value="2024, Term 1, End Term Exam">2024, Term 1, End Term Exam</option>
<option value="2024, Term 2, Opener Exam">2024, Term 2, Opener Exam</option>
<option value="2024, Term 2, Midterm Exam">2024, Term 2, Midterm Exam</option>
<option value="2024, Term 2, End Term Exam">2024, Term 2, End Term Exam</option>
<option value="2024, Term 3, Opener Exam">2024, Term 3, Opener Exam</option>
<option value="2024, Term 3, Midterm Exam">2024, Term 3, Midterm Exam</option>
<option value="2024, Term 3, End Term Exam">2024, Term 3, End Term Exam</option>

<option value="2025, Term 1, Opener Exam">2025, Term 1, Opener Exam</option>
<option value="2025, Term 1, Midterm Exam">2025, Term 1, Midterm Exam</option>
<option value="2025, Term 1, End Term Exam">2025, Term 1, End Term Exam</option>
<option value="2025, Term 2, Opener Exam">2025, Term 2, Opener Exam</option>
<option value="2025, Term 2, Midterm Exam">2025, Term 2, Midterm Exam</option>
<option value="2025, Term 2, End Term Exam">2025, Term 2, End Term Exam</option>
<option value="2025, Term 3, Opener Exam">2025, Term 3, Opener Exam</option>
<option value="2025, Term 3, Midterm Exam">2025, Term 3, Midterm Exam</option>
<option value="2025, Term 3, End Term Exam">2025, Term 3, End Term Exam</option>

<option value="2026, Term 1, Opener Exam">2026, Term 1, Opener Exam</option>
<option value="2026, Term 1, Midterm Exam">2026, Term 1, Midterm Exam</option>
<option value="2026, Term 1, End Term Exam">2026, Term 1, End Term Exam</option>
<option value="2026, Term 2, Opener Exam">2026, Term 2, Opener Exam</option>
<option value="2026, Term 2, Midterm Exam">2026, Term 2, Midterm Exam</option>
<option value="2026, Term 2, End Term Exam">2026, Term 2, End Term Exam</option>
<option value="2026, Term 3, Opener Exam">2026, Term 3, Opener Exam</option>
<option value="2026, Term 3, Midterm Exam">2026, Term 3, Midterm Exam</option>
<option value="2026, Term 3, End Term Exam">2026, Term 3, End Term Exam</option>

<option value="2027, Term 1, Opener Exam">2027, Term 1, Opener Exam</option>
<option value="2027, Term 1, Midterm Exam">2027, Term 1, Midterm Exam</option>
<option value="2027, Term 1, End Term Exam">2027, Term 1, End Term Exam</option>
<option value="2027, Term 2, Opener Exam">2027, Term 2, Opener Exam</option>
<option value="2027, Term 2, Midterm Exam">2027, Term 2, Midterm Exam</option>
<option value="2027, Term 2, End Term Exam">2027, Term 2, End Term Exam</option>
<option value="2027, Term 3, Opener Exam">2027, Term 3, Opener Exam</option>
<option value="2027, Term 3, Midterm Exam">2027, Term 3, Midterm Exam</option>
<option value="2027, Term 3, End Term Exam">2027, Term 3, End Term Exam</option>
<!-- 2028 -->
<option value="2028, Term 1, Opener Exam">2028, Term 1, Opener Exam</option>
<option value="2028, Term 1, Midterm Exam">2028, Term 1, Midterm Exam</option>
<option value="2028, Term 1, End Term Exam">2028, Term 1, End Term Exam</option>
<option value="2028, Term 2, Opener Exam">2028, Term 2, Opener Exam</option>
<option value="2028, Term 2, Midterm Exam">2028, Term 2, Midterm Exam</option>
<option value="2028, Term 2, End Term Exam">2028, Term 2, End Term Exam</option>
<option value="2028, Term 3, Opener Exam">2028, Term 3, Opener Exam</option>
<option value="2028, Term 3, Midterm Exam">2028, Term 3, Midterm Exam</option>
<option value="2028, Term 3, End Term Exam">2028, Term 3, End Term Exam</option>

<!-- 2029 -->
<option value="2029, Term 1, Opener Exam">2029, Term 1, Opener Exam</option>
<option value="2029, Term 1, Midterm Exam">2029, Term 1, Midterm Exam</option>
<option value="2029, Term 1, End Term Exam">2029, Term 1, End Term Exam</option>
<option value="2029, Term 2, Opener Exam">2029, Term 2, Opener Exam</option>
<option value="2029, Term 2, Midterm Exam">2029, Term 2, Midterm Exam</option>
<option value="2029, Term 2, End Term Exam">2029, Term 2, End Term Exam</option>
<option value="2029, Term 3, Opener Exam">2029, Term 3, Opener Exam</option>
<option value="2029, Term 3, Midterm Exam">2029, Term 3, Midterm Exam</option>
<option value="2029, Term 3, End Term Exam">2029, Term 3, End Term Exam</option>

<!-- 2030 -->
<option value="2030, Term 1, Opener Exam">2030, Term 1, Opener Exam</option>
<option value="2030, Term 1, Midterm Exam">2030, Term 1, Midterm Exam</option>
<option value="2030, Term 1, End Term Exam">2030, Term 1, End Term Exam</option>
<option value="2030, Term 2, Opener Exam">2030, Term 2, Opener Exam</option>
<option value="2030, Term 2, Midterm Exam">2030, Term 2, Midterm Exam</option>
<option value="2030, Term 2, End Term Exam">2030, Term 2, End Term Exam</option>
<option value="2030, Term 3, Opener Exam">2030, Term 3, Opener Exam</option>
<option value="2030, Term 3, Midterm Exam">2030, Term 3, Midterm Exam</option>
<option value="2030, Term 3, End Term Exam">2030, Term 3, End Term Exam</option>

<!-- 2031 -->
<option value="2031, Term 1, Opener Exam">2031, Term 1, Opener Exam</option>
<option value="2031, Term 1, Midterm Exam">2031, Term 1, Midterm Exam</option>
<option value="2031, Term 1, End Term Exam">2031, Term 1, End Term Exam</option>
<option value="2031, Term 2, Opener Exam">2031, Term 2, Opener Exam</option>
<option value="2031, Term 2, Midterm Exam">2031, Term 2, Midterm Exam</option>
<option value="2031, Term 2, End Term Exam">2031, Term 2, End Term Exam</option>
<option value="2031, Term 3, Opener Exam">2031, Term 3, Opener Exam</option>
<option value="2031, Term 3, Midterm Exam">2031, Term 3, Midterm Exam</option>
<option value="2031, Term 3, End Term Exam">2031, Term 3, End Term Exam</option>

<!-- 2032 -->
<option value="2032, Term 1, Opener Exam">2032, Term 1, Opener Exam</option>
<option value="2032, Term 1, Midterm Exam">2032, Term 1, Midterm Exam</option>
<option value="2032, Term 1, End Term Exam">2032, Term 1, End Term Exam</option>
<option value="2032, Term 2, Opener Exam">2032, Term 2, Opener Exam</option>
<option value="2032, Term 2, Midterm Exam">2032, Term 2, Midterm Exam</option>
<option value="2032, Term 2, End Term Exam">2032, Term 2, End Term Exam</option>
<option value="2032, Term 3, Opener Exam">2032, Term 3, Opener Exam</option>
<option value="2032, Term 3, Midterm Exam">2032, Term 3, Midterm Exam</option>
<option value="2032, Term 3, End Term Exam">2032, Term 3, End Term Exam</option>
<!-- 2033 -->
<option value="2033, Term 1, Opener Exam">2033, Term 1, Opener Exam</option>
<option value="2033, Term 1, Midterm Exam">2033, Term 1, Midterm Exam</option>
<option value="2033, Term 1, End Term Exam">2033, Term 1, End Term Exam</option>
<option value="2033, Term 2, Opener Exam">2033, Term 2, Opener Exam</option>
<option value="2033, Term 2, Midterm Exam">2033, Term 2, Midterm Exam</option>
<option value="2033, Term 2, End Term Exam">2033, Term 2, End Term Exam</option>
<option value="2033, Term 3, Opener Exam">2033, Term 3, Opener Exam</option>
<option value="2033, Term 3, Midterm Exam">2033, Term 3, Midterm Exam</option>
<option value="2033, Term 3, End Term Exam">2033, Term 3, End Term Exam</option>

<!-- 2034 -->
<option value="2034, Term 1, Opener Exam">2034, Term 1, Opener Exam</option>
<option value="2034, Term 1, Midterm Exam">2034, Term 1, Midterm Exam</option>
<option value="2034, Term 1, End Term Exam">2034, Term 1, End Term Exam</option>
<option value="2034, Term 2, Opener Exam">2034, Term 2, Opener Exam</option>
<option value="2034, Term 2, Midterm Exam">2034, Term 2, Midterm Exam</option>
<option value="2034, Term 2, End Term Exam">2034, Term 2, End Term Exam</option>
<option value="2034, Term 3, Opener Exam">2034, Term 3, Opener Exam</option>
<option value="2034, Term 3, Midterm Exam">2034, Term 3, Midterm Exam</option>
<option value="2034, Term 3, End Term Exam">2034, Term 3, End Term Exam</option>

<!-- 2035 -->
<option value="2035, Term 1, Opener Exam">2035, Term 1, Opener Exam</option>
<option value="2035, Term 1, Midterm Exam">2035, Term 1, Midterm Exam</option>
<option value="2035, Term 1, End Term Exam">2035, Term 1, End Term Exam</option>
<option value="2035, Term 2, Opener Exam">2035, Term 2, Opener Exam</option>
<option value="2035, Term 2, Midterm Exam">2035, Term 2, Midterm Exam</option>
<option value="2035, Term 2, End Term Exam">2035, Term 2, End Term Exam</option>
<option value="2035, Term 3, Opener Exam">2035, Term 3, Opener Exam</option>
<option value="2035, Term 3, Midterm Exam">2035, Term 3, Midterm Exam</option>
<option value="2035, Term 3, End Term Exam">2035, Term 3, End Term Exam</option>

<!-- 2036 -->
<option value="2036, Term 1, Opener Exam">2036, Term 1, Opener Exam</option>
<option value="2036, Term 1, Midterm Exam">2036, Term 1, Midterm Exam</option>
<option value="2036, Term 1, End Term Exam">2036, Term 1, End Term Exam</option>
<option value="2036, Term 2, Opener Exam">2036, Term 2, Opener Exam</option>
<option value="2036, Term 2, Midterm Exam">2036, Term 2, Midterm Exam</option>
<option value="2036, Term 2, End Term Exam">2036, Term 2, End Term Exam</option>
<option value="2036, Term 3, Opener Exam">2036, Term 3, Opener Exam</option>
<option value="2036, Term 3, Midterm Exam">2036, Term 3, Midterm Exam</option>
<option value="2036, Term 3, End Term Exam">2036, Term 3, End Term Exam</option>

<!-- 2037 -->
<option value="2037, Term 1, Opener Exam">2037, Term 1, Opener Exam</option>
<option value="2037, Term 1, Midterm Exam">2037, Term 1, Midterm Exam</option>
<option value="2037, Term 1, End Term Exam">2037, Term 1, End Term Exam</option>
<option value="2037, Term 2, Opener Exam">2037, Term 2, Opener Exam</option>
<option value="2037, Term 2, Midterm Exam">2037, Term 2, Midterm Exam</option>
<option value="2037, Term 2, End Term Exam">2037, Term 2, End Term Exam</option>
<option value="2037, Term 3, Opener Exam">2037, Term 3, Opener Exam</option>
<option value="2037, Term 3, Midterm Exam">2037, Term 3, Midterm Exam</option>
<option value="2037, Term 3, End Term Exam">2037, Term 3, End Term Exam</option>

<option value="2038, Term 1, Opener Exam">2038, Term 1, Opener Exam</option>
<option value="2038, Term 1, Midterm Exam">2038, Term 1, Midterm Exam</option>
<option value="2038, Term 1, End Term Exam">2038, Term 1, End Term Exam</option>
<option value="2038, Term 2, Opener Exam">2038, Term 2, Opener Exam</option>
<option value="2038, Term 2, Midterm Exam">2038, Term 2, Midterm Exam</option>
<option value="2038, Term 2, End Term Exam">2038, Term 2, End Term Exam</option>
<option value="2038, Term 3, Opener Exam">2038, Term 3, Opener Exam</option>
<option value="2038, Term 3, Midterm Exam">2038, Term 3, Midterm Exam</option>
<option value="2038, Term 3, End Term Exam">2038, Term 3, End Term Exam</option>


<option value="2039, Term 1, Opener Exam">2039, Term 1, Opener Exam</option>
<option value="2039, Term 1, Midterm Exam">2039, Term 1, Midterm Exam</option>
<option value="2039, Term 1, End Term Exam">2039, Term 1, End Term Exam</option>
<option value="2039, Term 2, Opener Exam">2039, Term 2, Opener Exam</option>
<option value="2039, Term 2, Midterm Exam">2039, Term 2, Midterm Exam</option>
<option value="2039, Term 2, End Term Exam">2039, Term 2, End Term Exam</option>
<option value="2039, Term 3, Opener Exam">2039, Term 3, Opener Exam</option>
<option value="2039, Term 3, Midterm Exam">2039, Term 3, Midterm Exam</option>
<option value="2039, Term 3, End Term Exam">2039, Term 3, End Term Exam</option>

<option value="2040, Term 1, Opener Exam">2040, Term 1, Opener Exam</option>
<option value="2040, Term 1, Midterm Exam">2040, Term 1, Midterm Exam</option>
<option value="2040, Term 1, End Term Exam">2040, Term 1, End Term Exam</option>
<option value="2040, Term 2, Opener Exam">2040, Term 2, Opener Exam</option>
<option value="2040, Term 2, Midterm Exam">2040, Term 2, Midterm Exam</option>
<option value="2040, Term 2, End Term Exam">2040, Term 2, End Term Exam</option>
<option value="2040, Term 3, Opener Exam">2040, Term 3, Opener Exam</option>
<option value="2040, Term 3, Midterm Exam">2040, Term 3, Midterm Exam</option>
<option value="2040, Term 3, End Term Exam">2040, Term 3, End Term Exam</option>

    </select>
    </div>

    <!-- Load Marks Button -->
    <div class="form-group">
      <label>&nbsp;</label> <!-- Empty label for alignment -->
 <button id="loadMarksByPeriodBtn" class="print-button" style="display: block; width: 180px;">
    <i class="fas fa-download"></i> Load Marks
  </button>
    </div>

    <!-- Print Marks Button -->
    <div class="form-group">
      <label>&nbsp;</label> <!-- Empty label for alignment -->
 <button id="printFilteredMarksBtn" class="print-button" style="display: block; width: 180px;">
    <i class="fas fa-print"></i> Print Filtered Marks
  </button>

    </div>

  </div>

  <!-- Marks Table -->
  <table class="marks-table" style="margin-top: 20px;">
    <thead>
      <tr>

        <th>No.</th>
        <th>Name</th>
        <th>Grade</th>
        <th>Eng</th><th>Lev</th>
        <th>Math</th><th>Lev</th>
        <th>Pre-Tech</th><th>Lev</th>
        <th>Kiswa</th><th>Lev</th>
        <th>Scie</th><th>Lev</th>
        <th>Sst</th><th>Lev</th>
        <th>Agric</th><th>Lev</th>
        <th>CRE</th><th>Lev</th>
        <th>C/A</th><th>Lev</th>
        <th>Total Marks</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="marksList"></tbody>
    <tfoot>
      <tr id="totalsRow"></tr>
      <tr id="averagesRow"></tr>
    </tfoot>
  </table>
</div>

<!-- Performance Reports Section -->
<div id="performanceReportsSection" style="display: none;">

  <h2 style="background-color: #ffff00; padding: 8px 16px; border-radius: 6px; display: inline-block;">
    Exam Reports
  </h2>

  <!-- RASM Reminder FIRST -->
  <div style="
    background-color: #2ecc71;
    color: #5a5300;
    border: 1px solid #ffe58f;
    padding: 12px 16px;
    border-radius: 6px;
    display: flex;
    align-items: center;
    margin: 20px 0;
    font-size: 16px;
  ">
    <i class="fas fa-bullhorn" style="color: #000; font-size: 24px; margin-right: 10px;"></i>
    <strong>RASM Reminder:</strong>&nbsp;Please select  grade,exam period and subject before generating any report ,Thankyou.
  </div>
<!-- Grade Selection -->
<div style="margin-bottom: 16px;">
  <label for="reportGradeSelect" style="font-weight: bold; display: block; margin-bottom: 4px;">Select Grade:</label>
  <select id="reportGradeSelect" 
    style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; width: 20%; background-color: #fff8c6;">
    <option value="">Select Grade</option>
  </select>
  <div style="font-size: 13px; color: #555; margin-top: 4px;">
    <i class="fas fa-info-circle" style="margin-right: 5px; color: #333;"></i>
    Select the learner grade whose report you wish to generate.
<div style="margin-bottom: 16px;">
  <label for="reportExamPeriodSelect" style="font-weight: bold; display: block; margin-bottom: 4px;">Select Exam Period:</label>
  <select id="reportExamPeriodSelect" 
    style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; width: 20%; background-color: #fff8c6;">
    <option value="">-- Select Exam Period --</option>
    <option value="2024, Term 1, Opener Exam">2024, Term 1, Opener Exam</option>
<option value="2024, Term 1, Midterm Exam">2024, Term 1, Midterm Exam</option>
<option value="2024, Term 1, End Term Exam">2024, Term 1, End Term Exam</option>
<option value="2024, Term 2, Opener Exam">2024, Term 2, Opener Exam</option>
<option value="2024, Term 2, Midterm Exam">2024, Term 2, Midterm Exam</option>
<option value="2024, Term 2, End Term Exam">2024, Term 2, End Term Exam</option>
<option value="2024, Term 3, Opener Exam">2024, Term 3, Opener Exam</option>
<option value="2024, Term 3, Midterm Exam">2024, Term 3, Midterm Exam</option>
<option value="2024, Term 3, End Term Exam">2024, Term 3, End Term Exam</option>

<option value="2025, Term 1, Opener Exam">2025, Term 1, Opener Exam</option>
<option value="2025, Term 1, Midterm Exam">2025, Term 1, Midterm Exam</option>
<option value="2025, Term 1, End Term Exam">2025, Term 1, End Term Exam</option>
<option value="2025, Term 2, Opener Exam">2025, Term 2, Opener Exam</option>
<option value="2025, Term 2, Midterm Exam">2025, Term 2, Midterm Exam</option>
<option value="2025, Term 2, End Term Exam">2025, Term 2, End Term Exam</option>
<option value="2025, Term 3, Opener Exam">2025, Term 3, Opener Exam</option>
<option value="2025, Term 3, Midterm Exam">2025, Term 3, Midterm Exam</option>
<option value="2025, Term 3, End Term Exam">2025, Term 3, End Term Exam</option>

<option value="2026, Term 1, Opener Exam">2026, Term 1, Opener Exam</option>
<option value="2026, Term 1, Midterm Exam">2026, Term 1, Midterm Exam</option>
<option value="2026, Term 1, End Term Exam">2026, Term 1, End Term Exam</option>
<option value="2026, Term 2, Opener Exam">2026, Term 2, Opener Exam</option>
<option value="2026, Term 2, Midterm Exam">2026, Term 2, Midterm Exam</option>
<option value="2026, Term 2, End Term Exam">2026, Term 2, End Term Exam</option>
<option value="2026, Term 3, Opener Exam">2026, Term 3, Opener Exam</option>
<option value="2026, Term 3, Midterm Exam">2026, Term 3, Midterm Exam</option>
<option value="2026, Term 3, End Term Exam">2026, Term 3, End Term Exam</option>

<option value="2027, Term 1, Opener Exam">2027, Term 1, Opener Exam</option>
<option value="2027, Term 1, Midterm Exam">2027, Term 1, Midterm Exam</option>
<option value="2027, Term 1, End Term Exam">2027, Term 1, End Term Exam</option>
<option value="2027, Term 2, Opener Exam">2027, Term 2, Opener Exam</option>
<option value="2027, Term 2, Midterm Exam">2027, Term 2, Midterm Exam</option>
<option value="2027, Term 2, End Term Exam">2027, Term 2, End Term Exam</option>
<option value="2027, Term 3, Opener Exam">2027, Term 3, Opener Exam</option>
<option value="2027, Term 3, Midterm Exam">2027, Term 3, Midterm Exam</option>
<option value="2027, Term 3, End Term Exam">2027, Term 3, End Term Exam</option>
<!-- 2028 -->
<option value="2028, Term 1, Opener Exam">2028, Term 1, Opener Exam</option>
<option value="2028, Term 1, Midterm Exam">2028, Term 1, Midterm Exam</option>
<option value="2028, Term 1, End Term Exam">2028, Term 1, End Term Exam</option>
<option value="2028, Term 2, Opener Exam">2028, Term 2, Opener Exam</option>
<option value="2028, Term 2, Midterm Exam">2028, Term 2, Midterm Exam</option>
<option value="2028, Term 2, End Term Exam">2028, Term 2, End Term Exam</option>
<option value="2028, Term 3, Opener Exam">2028, Term 3, Opener Exam</option>
<option value="2028, Term 3, Midterm Exam">2028, Term 3, Midterm Exam</option>
<option value="2028, Term 3, End Term Exam">2028, Term 3, End Term Exam</option>

<!-- 2029 -->
<option value="2029, Term 1, Opener Exam">2029, Term 1, Opener Exam</option>
<option value="2029, Term 1, Midterm Exam">2029, Term 1, Midterm Exam</option>
<option value="2029, Term 1, End Term Exam">2029, Term 1, End Term Exam</option>
<option value="2029, Term 2, Opener Exam">2029, Term 2, Opener Exam</option>
<option value="2029, Term 2, Midterm Exam">2029, Term 2, Midterm Exam</option>
<option value="2029, Term 2, End Term Exam">2029, Term 2, End Term Exam</option>
<option value="2029, Term 3, Opener Exam">2029, Term 3, Opener Exam</option>
<option value="2029, Term 3, Midterm Exam">2029, Term 3, Midterm Exam</option>
<option value="2029, Term 3, End Term Exam">2029, Term 3, End Term Exam</option>

<!-- 2030 -->
<option value="2030, Term 1, Opener Exam">2030, Term 1, Opener Exam</option>
<option value="2030, Term 1, Midterm Exam">2030, Term 1, Midterm Exam</option>
<option value="2030, Term 1, End Term Exam">2030, Term 1, End Term Exam</option>
<option value="2030, Term 2, Opener Exam">2030, Term 2, Opener Exam</option>
<option value="2030, Term 2, Midterm Exam">2030, Term 2, Midterm Exam</option>
<option value="2030, Term 2, End Term Exam">2030, Term 2, End Term Exam</option>
<option value="2030, Term 3, Opener Exam">2030, Term 3, Opener Exam</option>
<option value="2030, Term 3, Midterm Exam">2030, Term 3, Midterm Exam</option>
<option value="2030, Term 3, End Term Exam">2030, Term 3, End Term Exam</option>

<!-- 2031 -->
<option value="2031, Term 1, Opener Exam">2031, Term 1, Opener Exam</option>
<option value="2031, Term 1, Midterm Exam">2031, Term 1, Midterm Exam</option>
<option value="2031, Term 1, End Term Exam">2031, Term 1, End Term Exam</option>
<option value="2031, Term 2, Opener Exam">2031, Term 2, Opener Exam</option>
<option value="2031, Term 2, Midterm Exam">2031, Term 2, Midterm Exam</option>
<option value="2031, Term 2, End Term Exam">2031, Term 2, End Term Exam</option>
<option value="2031, Term 3, Opener Exam">2031, Term 3, Opener Exam</option>
<option value="2031, Term 3, Midterm Exam">2031, Term 3, Midterm Exam</option>
<option value="2031, Term 3, End Term Exam">2031, Term 3, End Term Exam</option>

<!-- 2032 -->
<option value="2032, Term 1, Opener Exam">2032, Term 1, Opener Exam</option>
<option value="2032, Term 1, Midterm Exam">2032, Term 1, Midterm Exam</option>
<option value="2032, Term 1, End Term Exam">2032, Term 1, End Term Exam</option>
<option value="2032, Term 2, Opener Exam">2032, Term 2, Opener Exam</option>
<option value="2032, Term 2, Midterm Exam">2032, Term 2, Midterm Exam</option>
<option value="2032, Term 2, End Term Exam">2032, Term 2, End Term Exam</option>
<option value="2032, Term 3, Opener Exam">2032, Term 3, Opener Exam</option>
<option value="2032, Term 3, Midterm Exam">2032, Term 3, Midterm Exam</option>
<option value="2032, Term 3, End Term Exam">2032, Term 3, End Term Exam</option>
<!-- 2033 -->
<option value="2033, Term 1, Opener Exam">2033, Term 1, Opener Exam</option>
<option value="2033, Term 1, Midterm Exam">2033, Term 1, Midterm Exam</option>
<option value="2033, Term 1, End Term Exam">2033, Term 1, End Term Exam</option>
<option value="2033, Term 2, Opener Exam">2033, Term 2, Opener Exam</option>
<option value="2033, Term 2, Midterm Exam">2033, Term 2, Midterm Exam</option>
<option value="2033, Term 2, End Term Exam">2033, Term 2, End Term Exam</option>
<option value="2033, Term 3, Opener Exam">2033, Term 3, Opener Exam</option>
<option value="2033, Term 3, Midterm Exam">2033, Term 3, Midterm Exam</option>
<option value="2033, Term 3, End Term Exam">2033, Term 3, End Term Exam</option>

<!-- 2034 -->
<option value="2034, Term 1, Opener Exam">2034, Term 1, Opener Exam</option>
<option value="2034, Term 1, Midterm Exam">2034, Term 1, Midterm Exam</option>
<option value="2034, Term 1, End Term Exam">2034, Term 1, End Term Exam</option>
<option value="2034, Term 2, Opener Exam">2034, Term 2, Opener Exam</option>
<option value="2034, Term 2, Midterm Exam">2034, Term 2, Midterm Exam</option>
<option value="2034, Term 2, End Term Exam">2034, Term 2, End Term Exam</option>
<option value="2034, Term 3, Opener Exam">2034, Term 3, Opener Exam</option>
<option value="2034, Term 3, Midterm Exam">2034, Term 3, Midterm Exam</option>
<option value="2034, Term 3, End Term Exam">2034, Term 3, End Term Exam</option>

<!-- 2035 -->
<option value="2035, Term 1, Opener Exam">2035, Term 1, Opener Exam</option>
<option value="2035, Term 1, Midterm Exam">2035, Term 1, Midterm Exam</option>
<option value="2035, Term 1, End Term Exam">2035, Term 1, End Term Exam</option>
<option value="2035, Term 2, Opener Exam">2035, Term 2, Opener Exam</option>
<option value="2035, Term 2, Midterm Exam">2035, Term 2, Midterm Exam</option>
<option value="2035, Term 2, End Term Exam">2035, Term 2, End Term Exam</option>
<option value="2035, Term 3, Opener Exam">2035, Term 3, Opener Exam</option>
<option value="2035, Term 3, Midterm Exam">2035, Term 3, Midterm Exam</option>
<option value="2035, Term 3, End Term Exam">2035, Term 3, End Term Exam</option>

<!-- 2036 -->
<option value="2036, Term 1, Opener Exam">2036, Term 1, Opener Exam</option>
<option value="2036, Term 1, Midterm Exam">2036, Term 1, Midterm Exam</option>
<option value="2036, Term 1, End Term Exam">2036, Term 1, End Term Exam</option>
<option value="2036, Term 2, Opener Exam">2036, Term 2, Opener Exam</option>
<option value="2036, Term 2, Midterm Exam">2036, Term 2, Midterm Exam</option>
<option value="2036, Term 2, End Term Exam">2036, Term 2, End Term Exam</option>
<option value="2036, Term 3, Opener Exam">2036, Term 3, Opener Exam</option>
<option value="2036, Term 3, Midterm Exam">2036, Term 3, Midterm Exam</option>
<option value="2036, Term 3, End Term Exam">2036, Term 3, End Term Exam</option>

<!-- 2037 -->
<option value="2037, Term 1, Opener Exam">2037, Term 1, Opener Exam</option>
<option value="2037, Term 1, Midterm Exam">2037, Term 1, Midterm Exam</option>
<option value="2037, Term 1, End Term Exam">2037, Term 1, End Term Exam</option>
<option value="2037, Term 2, Opener Exam">2037, Term 2, Opener Exam</option>
<option value="2037, Term 2, Midterm Exam">2037, Term 2, Midterm Exam</option>
<option value="2037, Term 2, End Term Exam">2037, Term 2, End Term Exam</option>
<option value="2037, Term 3, Opener Exam">2037, Term 3, Opener Exam</option>
<option value="2037, Term 3, Midterm Exam">2037, Term 3, Midterm Exam</option>
<option value="2037, Term 3, End Term Exam">2037, Term 3, End Term Exam</option>

<option value="2038, Term 1, Opener Exam">2038, Term 1, Opener Exam</option>
<option value="2038, Term 1, Midterm Exam">2038, Term 1, Midterm Exam</option>
<option value="2038, Term 1, End Term Exam">2038, Term 1, End Term Exam</option>
<option value="2038, Term 2, Opener Exam">2038, Term 2, Opener Exam</option>
<option value="2038, Term 2, Midterm Exam">2038, Term 2, Midterm Exam</option>
<option value="2038, Term 2, End Term Exam">2038, Term 2, End Term Exam</option>
<option value="2038, Term 3, Opener Exam">2038, Term 3, Opener Exam</option>
<option value="2038, Term 3, Midterm Exam">2038, Term 3, Midterm Exam</option>
<option value="2038, Term 3, End Term Exam">2038, Term 3, End Term Exam</option>


<option value="2039, Term 1, Opener Exam">2039, Term 1, Opener Exam</option>
<option value="2039, Term 1, Midterm Exam">2039, Term 1, Midterm Exam</option>
<option value="2039, Term 1, End Term Exam">2039, Term 1, End Term Exam</option>
<option value="2039, Term 2, Opener Exam">2039, Term 2, Opener Exam</option>
<option value="2039, Term 2, Midterm Exam">2039, Term 2, Midterm Exam</option>
<option value="2039, Term 2, End Term Exam">2039, Term 2, End Term Exam</option>
<option value="2039, Term 3, Opener Exam">2039, Term 3, Opener Exam</option>
<option value="2039, Term 3, Midterm Exam">2039, Term 3, Midterm Exam</option>
<option value="2039, Term 3, End Term Exam">2039, Term 3, End Term Exam</option>

<option value="2040, Term 1, Opener Exam">2040, Term 1, Opener Exam</option>
<option value="2040, Term 1, Midterm Exam">2040, Term 1, Midterm Exam</option>
<option value="2040, Term 1, End Term Exam">2040, Term 1, End Term Exam</option>
<option value="2040, Term 2, Opener Exam">2040, Term 2, Opener Exam</option>
<option value="2040, Term 2, Midterm Exam">2040, Term 2, Midterm Exam</option>
<option value="2040, Term 2, End Term Exam">2040, Term 2, End Term Exam</option>
<option value="2040, Term 3, Opener Exam">2040, Term 3, Opener Exam</option>
<option value="2040, Term 3, Midterm Exam">2040, Term 3, Midterm Exam</option>
<option value="2040, Term 3, End Term Exam">2040, Term 3, End Term Exam</option>

  </select>


  </div>
</div>

<!-- Subject Selection -->
<div style="margin-bottom: 16px;">
  <label for="rankingSubjectSelect" style="font-weight: bold; display: block; margin-bottom: 4px;">Select Subject:</label>
  <select id="rankingSubjectSelect" 
    style="padding: 8px 12px; border-radius: 5px; border: 1px solid #ccc; width: 20%; background-color: #fff8c6;">
    <option value="">Select Subject</option>
    <option value="eng">English</option>
    <option value="math">Mathematics</option>
    <option value="preTech">Pre-Technical Studies</option>
    <option value="kiswahili">Kiswahili</option>
    <option value="science">Integrated Science</option>
    <option value="social">Social Studies</option>
    <option value="agriculture">Agriculture</option>
    <option value="cre">Religious Education</option>
    <option value="creativeArt">Creative Art</option>
  </select>
  <div style="font-size: 13px; color: #555; margin-top: 4px;">
    <i class="fas fa-info-circle" style="margin-right: 5px; color: #333;"></i>
    Select the subject you want to analyze performance for.
  </div>
<div class="form-group" style="margin-top: 20px;">
  <label for="meritGradeSelect"><strong>Select Grade for Blank Merit List:</strong></label>
  <select id="meritGradeSelect" style="padding: 6px; border-radius: 4px; width: 250px;">
    <option value="">Loading grades...</option>
  </select>


   <div style="
  background-color:#fff8c6;
  padding: 16px;
  border-radius: 8px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-width: 320px;
  margin: 0;
">

<button class="report-button red" id="subjectChampionsBtn" style="width: 60%;">
  <i class="fas fa-trophy"></i> Subjects Champions
</button>

<button class="report-button blue" id="subjectPerformanceBtn" style="width: 60%;">
  <i class="fas fa-chart-line"></i> Subject Performance
</button>

<button class="report-button green" id="genderPerformanceBtn" style="width: 60%;">
  <i class="fas fa-venus-mars"></i> Gender Performance
</button>

<button class="report-button purple" id="levelSummaryBtn" style="width: 65%;">
  <i class="fas fa-layer-group"></i> Subject Level Summary
</button>

<button class="report-button orange" id="combineMarksByGradeBtn" style="width: 70%;">
  <i class="fas fa-object-group"></i> Combine Marks Per Grade
</button>

<button class="report-button teal" id="groupByPathwaysBtn" style="width: 80%;">
  <i class="fas fa-project-diagram"></i> Group Learners Per Pathways
</button>

<button class="report-button green" id="generateAssessmentReportsBtn" style="width: 80%;">
  <i class="fas fa-file-alt"></i> Generate Assessment Reports
</button>

<button class="report-button gray" id="subjectRankingReportBtn" style="width: 80%;">
  <i class="fas fa-list-ol"></i> Learner Subject Performance 
</button>

<button class="report-button gray" id="generateBlankMeritBtn" style="width: 68%;">
  <i class="fas fa-file-alt"></i> Generate Blank Merit Lists
</button>

<button class="print-button" id="generateSubjectRankBtn" style="width: 65%;">
  <i class="fas fa-list-ol"></i> Generate Subject Ranking
</button>

<button id="printAssessmentReportBtn" class="print-button" style="width: 65%;">
  <i class="fas fa-print"></i> Print Assessment Report
</button>

<button id="showMarksStatusBtn" style="
  padding: 10px 16px;
  background-color: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  width: 65%;
">
  <i id="toggleIcon" class="fas fa-eye" style="color: white;"></i>
  Show Marks Recording Status Per Grade
</button>


    </div>

  </div>
</div>



<!-- Output Containers -->
<div id="reportOutput"></div>
<div id="assessmentReportsContainer" style="margin-top: 30px;"></div>

<!-- Teacher Modal -->
<div id="teacherModal" class="modal">
  <div class="modal-content">
    <span class="close-btn" onclick="closeTeacherModal()">&times;</span>
    <h3 class="modal-title">Enter Term and Subject Teacher Details</h3>

    <form id="teacherForm">
      <!-- Dynamic Inputs -->
      <div id="teacherInputs" class="dynamic-inputs"></div>

      <!-- Static Fields -->
      <div class="form-section">
        <div class="form-group">
          <label for="year">Year</label>
          <input type="number" id="year" required>
        </div>
        <div class="form-group">
          <label for="term">Term</label>
          <input type="text" id="term" required>
        </div>
        <div class="form-group">
          <label for="closingDate">Closing Date</label>
          <input type="date" id="closingDate" required>
        </div>
        <div class="form-group">
          <label for="openingDate">Opening Date</label>
          <input type="date" id="openingDate" required>
        </div>
        <div class="form-group">
          <label for="classTeacherSignature">Class Teacher Signature</label>
          <input type="text" id="classTeacherSignature" placeholder="Type your name or signature" required>
        </div>
        <div class="form-group">
          <label for="principalSignature">Principal Signature</label>
          <input type="text" id="principalSignature" placeholder="Type your name or signature" required>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="form-actions">
        <button type="submit" class="print-button">
          <i class="fas fa-arrow-right"></i> Continue to Reports
        </button>
      </div>
    </form>
  </div>
</div>
<div id="marksStatusSummary" style="margin-top: 20px; padding: 10px; background: #eef; border-radius: 6px;"></div>

<div id="customPrompt" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
  <div style="background:#fff; padding:20px; border-radius:10px; max-width:300px; text-align:center;">
    <h3 style="margin-top:0;">Combine Marks by Grade</h3>
    <input type="text" id="gradeInput" placeholder="e.g., 7 or 8" style="padding:8px; width:90%; margin-bottom:15px; border:1px solid #ccc; border-radius:5px;" />
    <div>
      <button id="confirmGradeBtn" style="padding:8px 15px; margin-right:10px; border:none; background:#3498db; color:white; border-radius:5px;">Combine</button>
      <button id="cancelGradeBtn" style="padding:8px 15px; border:none; background:#e74c3c; color:white; border-radius:5px;">Cancel</button>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>


  <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
        import { getDatabase, ref, push, set, onValue, remove } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDhTehL7VIaGG-bC2n1AFILZeJJ-drmSC0",
            authDomain: "rasm-school-management.firebaseapp.com",
            databaseURL: "https://rasm-school-management-default-rtdb.firebaseio.com",
            projectId: "rasm-school-management",
            storageBucket: "rasm-school-management.appspot.com",
            messagingSenderId: "1015313561987",
            appId: "1:1015313561987:web:4329664df844c17ae59eb6",
            measurementId: "G-MHKTNPG712"
        };

const app = initializeApp(firebaseConfig);
const database = getDatabase(app);
const learnersRef = ref(database, "learners");

document.getElementById('registerButton').addEventListener('click', () => {
    const name = document.getElementById('name').value.trim();
    const gender = document.getElementById('gender').value;
    const grade = document.getElementById('grade').value;
    const age = document.getElementById('age').value;
    const parentName = document.getElementById('parentName').value.trim();
    const parentPhone = document.getElementById('parentPhone').value.trim();
    const birthCert = document.getElementById('birthCert').value.trim();
    const admissionNo = document.getElementById('admissionNo').value.trim();
    const photo = document.getElementById('photo').files[0];

    if (!name || !gender || !grade) {
        Swal.fire({
            icon: 'error',
            title: 'Missing Required Fields',
            text: 'Please fill in Name, Gender, and Grade before submitting.',
            confirmButtonColor: '#d33'
        });
        return;
    }

    const learnerData = {
        name,
        gender,
        grade,
        ...(age && { age }),
        ...(parentName && { parentName }),
        ...(parentPhone && { parentPhone }),
        ...(birthCert && { birthCert }),
        ...(admissionNo && { admissionNo }),
        ...(photo && { photo: URL.createObjectURL(photo) }),
    };

    const newLearnerRef = push(learnersRef);
    set(newLearnerRef, learnerData)
        .then(() => {
            Swal.fire({
                icon: 'success',
                title: 'Success!',
                text: 'Learner registered successfully.',
                confirmButtonColor: '#28a745'
            });
            document.getElementById('learnerForm').reset();
        })
        .catch(err => {
            console.error("Error adding learner: ", err);
            Swal.fire({
                icon: 'error',
                title: 'Registration Failed',
                text: 'There was an issue saving learner data. Please try again.',
                confirmButtonColor: '#d33'
            });
        });
});


const tableBody = document.getElementById('learnersList');
const filterGradeSelect = document.getElementById('filterGrade'); // Reference to the dropdown

onValue(learnersRef, (snapshot) => {
    tableBody.innerHTML = "";
    const grades = new Set();
    let index = 1;

    snapshot.forEach(childSnapshot => {
        const data = childSnapshot.val();
        const learnerKey = childSnapshot.key;

        grades.add(data.grade);

        const newRow = document.createElement('tr');
        newRow.setAttribute('data-grade', data.grade);
        newRow.innerHTML = `
            <td>${index++}</td>
            <td><img src="${data.photo || 'default.png'}" alt="Photo"></td>
            <td contenteditable="true" class="editable">${data.name || ''}</td>
            <td contenteditable="true" class="editable">${data.gender || ''}</td>
            <td contenteditable="true" class="editable">${data.grade || ''}</td>
            <td contenteditable="true" class="editable">${data.age || ''}</td>
            <td contenteditable="true" class="editable">${data.parentName || ''}</td>
            <td contenteditable="true" class="editable">${data.parentPhone || ''}</td>
            <td contenteditable="true" class="editable">${data.birthCert || ''}</td>
            <td contenteditable="true" class="editable">${data.admissionNo || ''}</td>
            <td>
                <button class="edit-photo-btn" data-key="${learnerKey}">
                    <i class="fas fa-camera"></i> Edit Photo
                </button>
            </td>
            <td>
                <button class="delete-btn" data-key="${learnerKey}">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
            </td>
        `;

        tableBody.appendChild(newRow);

        //  Handle inline cell editing
        newRow.querySelectorAll('.editable').forEach(cell => {
            cell.addEventListener('blur', () => {
                const fieldIndex = cell.cellIndex;
                const fieldNames = ['name', 'gender', 'grade', 'age', 'parentName', 'parentPhone', 'birthCert', 'admissionNo'];
                const fieldName = fieldNames[fieldIndex - 2];
                const value = cell.textContent.trim();

                if (!fieldName || value === '') {
                    showToast("Field cannot be empty.", "error");
                    return;
                }

                const updatedLearner = {
                    ...data,
                    [fieldName]: value
                };

                set(ref(database, `learners/${learnerKey}`), updatedLearner)
                    .then(() => showToast(`${fieldName} updated successfully!`, "success"))
                    .catch(err => {
                        console.error("Error updating learner:", err);
                        showToast("Failed to update learner. Please try again.", "error");
                    });
            });
        });

        //  SweetAlert2 delete confirmation
        newRow.querySelector('.delete-btn').addEventListener('click', (e) => {
            const learnerKey = e.currentTarget.getAttribute('data-key');

            Swal.fire({
                title: 'Confirm Deletion',
                text: 'Are you sure you want to permanently delete this learner?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Yes, delete',
                cancelButtonText: 'Cancel'
            }).then((result) => {
                if (result.isConfirmed) {
                    remove(ref(database, `learners/${learnerKey}`))
                        .then(() => {
                            Swal.fire('Deleted!', 'Learner has been deleted.', 'success');
                        })
                        .catch(err => {
                            console.error("Error deleting learner:", err);
                            Swal.fire('Error', 'Failed to delete learner.', 'error');
                        });
                }
            });
        });
    });

    //  Populate the filterGrade dropdown
    if (filterGradeSelect) {
        filterGradeSelect.innerHTML = `<option value="">Filter by Grade</option>`;
        grades.forEach(grade => {
            const option = document.createElement('option');
            option.value = grade;
            option.textContent = grade;
            filterGradeSelect.appendChild(option);
        });
    }
});
// Filter learners table by name or admission number
  document.getElementById("searchInput").addEventListener("input", function () {
    const query = this.value.toLowerCase();
    const rows = document.querySelectorAll("#learnersList tr");

    rows.forEach(row => {
      const name = row.cells[2].textContent.toLowerCase();
      const admissionNo = row.cells[9].textContent.toLowerCase();

      if (name.includes(query) || admissionNo.includes(query)) {
        row.style.display = "";
      } else {
        row.style.display = "none";
      }
    });
  });

printButton.addEventListener('click', () => {
    const schoolName = "Your School Name";
    const year = "2025";
    const term = "Term 1";

    // Get the selected grade for filtering
    const selectedGrade = filterGrade.value;

    // Get the learners data for printing, only filtered by grade
    const learners = [];
    tableBody.querySelectorAll('tr').forEach((row, index) => {
        const grade = row.getAttribute('data-grade');
        if (selectedGrade === "" || grade === selectedGrade) {
            const learner = {
                name: row.cells[2].textContent,
                gender: row.cells[3].textContent,
                grade: row.cells[4].textContent,
                age: row.cells[5].textContent,
                parentName: row.cells[6].textContent,
                phone: row.cells[7].textContent,
                birthCertificateNo: row.cells[8].textContent,
                admissionNumber: row.cells[9].textContent,
                photo: "placeholder.jpg" // Placeholder image path
            };
            learners.push(learner);
        }
    });

    printRegisteredLearners(schoolName, year, term, learners);
});

function printRegisteredLearners(schoolName, year, term, learners) {
    const logoUrl = "https://i.imgur.com/UW65hfv.png"; // Logo URL

    const tableHtml = `
        <table class="learners-table">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Photo</th>
                    <th>Name</th>
                    <th>Gender</th>
                    <th>Grade</th>
                    <th>Age</th>
                    <th>Parent Name</th>
                    <th>Parent Phone No</th>
                    <th>Birth Certificate No</th>
                    <th>Admission Number</th>
                </tr>
            </thead>
            <tbody>
                ${learners.map((learner, index) => `
                    <tr>
                        <td>${index + 1}</td>
                        <td><img src="${learner.photo}" alt="Photo" width="50" height="50"></td>
                        <td>${learner.name}</td>
                        <td>${learner.gender}</td>
                        <td>${learner.grade}</td>
                        <td>${learner.age}</td>
                        <td>${learner.parentName}</td>
                        <td>${learner.phone}</td>
                        <td>${learner.birthCertificateNo}</td>
                        <td>${learner.admissionNumber}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Registered Learners</title>
                <style>
                    body { font-family: Arial, sans-serif; }
                    .header-info { text-align: left; margin-bottom: 20px; font-weight: bold; }
                    .learners-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                    .learners-table th, .learners-table td { border: 1px solid black; padding: 8px; text-align: center; }
                </style>
            </head>
            <body>
                <div class="header-info">
                    <img src="${logoUrl}" alt="Logo" width="50" height="50">
                    <p>School: ${schoolName}</p>
                    <p>Year: ${year} | Term: ${term}</p>
                </div>
                ${tableHtml}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

document.addEventListener('DOMContentLoaded', () => {
    // Get modal and close button
    const modal = document.getElementById('learnerModal');
    const closeBtn = document.querySelector('.close');

    // Function to open the modal with learner details
    function openModal(learnerData) {
        const modalDetails = document.getElementById('modalDetails');
        modalDetails.innerHTML = `
            <p><strong>Name:</strong> ${learnerData.name}</p>
            <p><strong>Gender:</strong> ${learnerData.gender}</p>
            <p><strong>Grade:</strong> ${learnerData.grade}</p>
            <p><strong>Age:</strong> ${learnerData.age}</p>
            <p><strong>Parent Name:</strong> ${learnerData.parentName}</p>
            <p><strong>Parent Phone:</strong> ${learnerData.parentPhone}</p>
            <p><strong>Birth Certificate No:</strong> ${learnerData.birthCert}</p>
            <p><strong>Admission No:</strong> ${learnerData.admissionNo}</p>
            <p><strong>Photo:</strong> <img src="${learnerData.photo}" alt="Learner Photo" style="max-width: 150px; border-radius: 50%;"></p>
        `;
        modal.style.display = "block"; // Show the modal
    }

    // Function to close the modal
    closeBtn.addEventListener('click', () => {
        modal.style.display = "none"; // Hide the modal
    });

    // Click event for learner names
    tableBody.addEventListener('click', (e) => {
        if (e.target && e.target.nodeName === "TD" && e.target.cellIndex === 2) {
            const row = e.target.closest('tr');
            const learnerKey = row.getAttribute('data-key');
            
            // Fetch learner data from Firebase or get the data from `row`
            const learnerData = {
                name: row.cells[2].textContent,
                gender: row.cells[3].textContent,
                grade: row.cells[4].textContent,
                age: row.cells[5].textContent,
                parentName: row.cells[6].textContent,
                parentPhone: row.cells[7].textContent,
                birthCert: row.cells[8].textContent,
                admissionNo: row.cells[9].textContent,
                photo: row.cells[1].querySelector('img').src // Assuming photo is in the second cell
            };
            
            openModal(learnerData); // Open the modal and pass learner data
        }
    });

    // Close the modal when clicking outside the modal content
    window.addEventListener('click', (e) => {
        if (e.target === modal) {
            modal.style.display = "none";
        }
    });
});
// Populate grades and learner dropdowns
onValue(learnersRef, (snapshot) => {
    const gradeSelect = document.getElementById("gradeSelect");
    const learnerSelect = document.getElementById("learnerSelect");
    const grades = new Set();

    learnerSelect.innerHTML = `<option value="">Select Learner</option>`;
    gradeSelect.innerHTML = `<option value="">Select Grade</option>`;

    snapshot.forEach(childSnapshot => {
        const learner = childSnapshot.val();
        grades.add(learner.grade);
    });

    grades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        gradeSelect.appendChild(option);
    });
});

// Update learners dropdown based on selected grade
document.getElementById('filterGrade').addEventListener('change', () => {
  const selectedGrade = document.getElementById('filterGrade').value;
  const allRows = document.querySelectorAll('#learnersList tr');

  allRows.forEach(row => {
    const rowGrade = row.getAttribute('data-grade');
    if (selectedGrade === "" || rowGrade === selectedGrade) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});

  // Attach event listeners
  document.getElementById("gradeSelect").addEventListener("change", filterLearnersByGradeOnly);
  document.getElementById("examPeriod").addEventListener("change", filterLearnersByGradeOnly);

  // Filter learners by grade + disable or mark learners who already have marks for selected exam period
  function filterLearnersByGradeOnly() {
    const selectedGrade = document.getElementById("gradeSelect").value;
    const examPeriod = document.getElementById("examPeriod").value;
    const learnerSelect = document.getElementById("learnerSelect");
    learnerSelect.innerHTML = "<option value=''>Select Learner</option>";

    if (!selectedGrade || !examPeriod) return;

    db.collection("learners")
      .where("grade", "==", selectedGrade)
      .get()
      .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
          const learner = doc.data();
          const option = document.createElement("option");
          option.value = learner.name;
          option.text = learner.name;

          // Check if marks exist for this learner & exam period
          db.collection("marks")
            .where("name", "==", learner.name)
            .where("examPeriod", "==", examPeriod)
            .get()
            .then((marksSnapshot) => {
              if (!marksSnapshot.empty) {
                option.disabled = true;
                option.text = `? ${learner.name}`;
                option.style.color = "red";
              }
              learnerSelect.appendChild(option);
            });
        });
      })
      .catch((error) => {
        console.error("Error fetching learners: ", error);
      });
  }

document.getElementById("saveMarksButton").addEventListener("click", () => {
  const learnerKey = document.getElementById("learnerSelect").value;
  if (!learnerKey) {
    Swal.fire({
      icon: 'error',
      title: 'Missing Learner',
      text: 'Please select a learner before saving marks.',
      confirmButtonColor: '#d33'
    });
    return;
  }

  const examPeriod = document.getElementById("examPeriod").value;
  if (!examPeriod) {
    Swal.fire({
      icon: 'error',
      title: 'Missing Exam Period',
      text: 'Please select the exam period before saving marks.',
      confirmButtonColor: '#d33'
    });
    return;
  }

  // Collect marks and calculate levels
  const marksData = {
    eng: document.getElementById("eng").value,
    engLev: getLevel(document.getElementById("eng").value),
    math: document.getElementById("math").value,
    mathLev: getLevel(document.getElementById("math").value),
    preTech: document.getElementById("preTech").value,
    preTechLev: getLevel(document.getElementById("preTech").value),
    kiswahili: document.getElementById("kiswahili").value,
    kiswahiliLev: getLevel(document.getElementById("kiswahili").value),
    science: document.getElementById("science").value,
    scienceLev: getLevel(document.getElementById("science").value),
    social: document.getElementById("social").value,
    socialLev: getLevel(document.getElementById("social").value),
    agriculture: document.getElementById("agriculture").value,
    agricultureLev: getLevel(document.getElementById("agriculture").value),
    cre: document.getElementById("cre").value,
    creLev: getLevel(document.getElementById("cre").value),
    creativeArt: document.getElementById("creativeArt").value,
    creativeArtLev: getLevel(document.getElementById("creativeArt").value)
  };

  // Save marks to database
  set(ref(database, `learners/${learnerKey}/marks/${examPeriod}`), marksData)
    .then(() => {
      Swal.fire({
        icon: 'success',
        title: 'Marks Saved',
        text: `Marks recorded successfully for ${examPeriod}!`,
        confirmButtonColor: '#28a745'
      });
      document.getElementById("marksForm").reset();
      filterLearnersWithMarks(); // Refresh learner list immediately after saving
    })
    .catch(err => {
      console.error("Error saving marks: ", err);
      Swal.fire({
        icon: 'error',
        title: 'Save Failed',
        text: 'Failed to record marks. Please try again.',
        confirmButtonColor: '#d33'
      });
    });
});

function filterLearnersWithMarks() {
  const gradeSelect = document.getElementById("gradeSelect");
  const learnerSelect = document.getElementById("learnerSelect");
  const selectedGrade = gradeSelect.value;
  const examPeriod = document.getElementById("examPeriod").value;
  const marksCountBadge = document.getElementById("marksCountBadge");

  learnerSelect.innerHTML = `<option value="">Select Learner</option>`; // Clear dropdown
  marksCountBadge.innerHTML = ""; // Clear badge initially

  if (!selectedGrade || !examPeriod) return;

  let totalLearners = 0;
  let learnersWithMarks = 0;

  onValue(learnersRef, (snapshot) => {
    learnerSelect.innerHTML = `<option value="">Select Learner</option>`; // Clear again inside

    snapshot.forEach(childSnapshot => {
      const learner = childSnapshot.val();

      if (learner.grade === selectedGrade) {
        totalLearners++;

        const option = document.createElement("option");
        option.value = childSnapshot.key;
        option.textContent = `${learner.name} (${learner.admissionNo})`;

        // Check if marks exist for this learner and period
        if (childSnapshot.child(`marks/${examPeriod}`).exists()) {
          option.disabled = true;
          option.textContent = ` ${learner.name} (${learner.admissionNo})`;
          option.style.color = "red";
          learnersWithMarks++;
        }

        learnerSelect.appendChild(option);
      }
    });

    // Update count badge after processing
    if (totalLearners > 0) {
      marksCountBadge.innerHTML = ` ${learnersWithMarks} / ${totalLearners} learners recorded for ${examPeriod}`;
    } else {
      marksCountBadge.innerHTML = `No learners found in ${selectedGrade}`;
    }
  });
}



// Update learner dropdown on grade change
document.getElementById("gradeSelect").addEventListener("change", filterLearnersWithMarks);

// Populate the initial dropdown
filterLearnersWithMarks();

const marksTableBody = document.getElementById("marksList");
const filterMarksGrade = document.getElementById("filterMarksGrade");
const marksExamPeriodSelect = document.getElementById("marksExamPeriodSelect");
function loadMarksFromFirebase() {
  const examPeriod = marksExamPeriodSelect.value;
  if (!examPeriod) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select an exam period to load marks.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }



  onValue(learnersRef, (snapshot) => {
    marksTableBody.innerHTML = "";
    const grades = new Set();
    let index = 1;

    let sums = {
      eng: 0, math: 0, preTech: 0, kiswahili: 0,
      science: 0, social: 0, agriculture: 0, cre: 0, creativeArt: 0, totalMarks: 0
    };

    let learnersWithMarks = 0;

    snapshot.forEach(childSnapshot => {
      const data = childSnapshot.val();
      const marksData = data.marks || {};
      const marks = marksData[examPeriod] || null;

      if (marks) {
        learnersWithMarks++;

        const rowTotal =
          (parseFloat(marks.eng) || 0) +
          (parseFloat(marks.math) || 0) +
          (parseFloat(marks.preTech) || 0) +
          (parseFloat(marks.kiswahili) || 0) +
          (parseFloat(marks.science) || 0) +
          (parseFloat(marks.social) || 0) +
          (parseFloat(marks.agriculture) || 0) +
          (parseFloat(marks.cre) || 0) +
          (parseFloat(marks.creativeArt) || 0);

        sums.eng += (parseFloat(marks.eng) || 0);
        sums.math += (parseFloat(marks.math) || 0);
        sums.preTech += (parseFloat(marks.preTech) || 0);
        sums.kiswahili += (parseFloat(marks.kiswahili) || 0);
        sums.science += (parseFloat(marks.science) || 0);
        sums.social += (parseFloat(marks.social) || 0);
        sums.agriculture += (parseFloat(marks.agriculture) || 0);
        sums.cre += (parseFloat(marks.cre) || 0);
        sums.creativeArt += (parseFloat(marks.creativeArt) || 0);
        sums.totalMarks += rowTotal;

        grades.add(data.grade);

        const row = document.createElement("tr");
        row.setAttribute("data-grade", data.grade);
       row.setAttribute("data-exam-period", examPeriod);
        row.innerHTML = `
          <td>${index++}</td>
          <td>${data.name}</td>
          <td>${data.grade}</td>
          <td>${marks.eng || ''}</td><td>${marks.engLev || ''}</td>
          <td>${marks.math || ''}</td><td>${marks.mathLev || ''}</td>
          <td>${marks.preTech || ''}</td><td>${marks.preTechLev || ''}</td>
          <td>${marks.kiswahili || ''}</td><td>${marks.kiswahiliLev || ''}</td>
          <td>${marks.science || ''}</td><td>${marks.scienceLev || ''}</td>
          <td>${marks.social || ''}</td><td>${marks.socialLev || ''}</td>
          <td>${marks.agriculture || ''}</td><td>${marks.agricultureLev || ''}</td>
          <td>${marks.cre || ''}</td><td>${marks.creLev || ''}</td>
          <td>${marks.creativeArt || ''}</td><td>${marks.creativeArtLev || ''}</td>
          <td><strong>${rowTotal}</strong></td>
          <td><button class="deleteMarksBtn" data-key="${childSnapshot.key}" data-exam="${examPeriod}">Delete Marks</button></td>
        `;
        marksTableBody.appendChild(row);
      }
    });

    populateGradeSelectors(grades);
    updateTotalsAndAverages(sums, learnersWithMarks);
  });
}

// Attach to button click
document.getElementById("loadMarksByPeriodBtn").addEventListener("click", loadMarksFromFirebase);


// ? Helper function   populate all grade dropdown selectors at once
function populateGradeSelectors(grades) {
    const selectors = [
        document.getElementById("filterMarksGrade"),
        document.getElementById("reportGradeSelect")
    ];
    selectors.forEach(select => {
        if (select) {
            select.innerHTML = `<option value="">Select Grade</option>`;
            grades.forEach(grade => {
                const option = document.createElement("option");
                option.value = grade;
                option.textContent = grade;
                select.appendChild(option);
            });
        }
    });
}

// Reusable function to display totals & averages
function updateTotalsAndAverages(sums, count) {
    const divisor = count > 0 ? count : 1;

    document.getElementById("totalsRow").innerHTML = `
        <td colspan="3"><strong>Totals</strong></td>
        <td>${sums.eng}</td><td></td>
        <td>${sums.math}</td><td></td>
        <td>${sums.preTech}</td><td></td>
        <td>${sums.kiswahili}</td><td></td>
        <td>${sums.science}</td><td></td>
        <td>${sums.social}</td><td></td>
        <td>${sums.agriculture}</td><td></td>
        <td>${sums.cre}</td><td></td>
        <td>${sums.creativeArt}</td><td></td>
        <td><strong>${sums.totalMarks}</strong></td>
    `;

    document.getElementById("averagesRow").innerHTML = `
        <td colspan="3"><strong>Averages</strong></td>
        <td>${(sums.eng / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.math / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.preTech / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.kiswahili / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.science / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.social / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.agriculture / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.cre / divisor).toFixed(2)}</td><td></td>
        <td>${(sums.creativeArt / divisor).toFixed(2)}</td><td></td>
        <td><strong>${(sums.totalMarks / divisor).toFixed(2)}</strong></td>
    `;
}

// Grade filter listener   recalculate on selection
filterMarksGrade.addEventListener("change", () => {
    const selectedGrade = filterMarksGrade.value;
    const rows = marksTableBody.querySelectorAll("tr");

    let sums = {
        eng: 0, math: 0, preTech: 0, kiswahili: 0,
        science: 0, social: 0, agriculture: 0, cre: 0, creativeArt: 0, totalMarks: 0
    };
    let filteredCount = 0;

    rows.forEach(row => {
        const rowGrade = row.getAttribute("data-grade");
        const visible = selectedGrade === "" || rowGrade === selectedGrade;
        row.style.display = visible ? "" : "none";

        if (visible) {
            const cells = row.querySelectorAll("td");
            sums.eng += parseFloat(cells[3].textContent) || 0;
            sums.math += parseFloat(cells[5].textContent) || 0;
            sums.preTech += parseFloat(cells[7].textContent) || 0;
            sums.kiswahili += parseFloat(cells[9].textContent) || 0;
            sums.science += parseFloat(cells[11].textContent) || 0;
            sums.social += parseFloat(cells[13].textContent) || 0;
            sums.agriculture += parseFloat(cells[15].textContent) || 0;
            sums.cre += parseFloat(cells[17].textContent) || 0;
            sums.creativeArt += parseFloat(cells[19].textContent) || 0;
            sums.totalMarks += parseFloat(cells[21].textContent) || 0;
            filteredCount++;
        }
    });

    updateTotalsAndAverages(sums, filteredCount);
});

function getLevel(score) {
    if (score >= 90) return "EE 1";
    if (score >= 75) return "EE 2";
    if (score >= 58) return "ME 1";
    if (score >= 41) return "ME 2";
    if (score >= 31) return "AE 1";
    if (score >= 21) return "AE 2";
    if (score >= 11) return "BE 1";
    return "BE 2";
}
document.addEventListener("click", function (e) {
  if (e.target.classList.contains("deleteMarksBtn")) {
    const button = e.target;
    const learnerKey = button.getAttribute("data-key");
    const examPeriod = button.getAttribute("data-exam");

    if (!learnerKey || !examPeriod) {
      console.warn("Missing learner key or exam period.");
      return;
    }

    // SweetAlert2 confirmation dialog
    Swal.fire({
      title: "Are you sure?",
      text: "You want to delete this learner's marks for this exam?",
      icon: "warning",
      showCancelButton: true,
      confirmButtonColor: "#d33",
      cancelButtonColor: "#3085d6",
      confirmButtonText: "Yes, delete it!"
    }).then((result) => {
      if (result.isConfirmed) {
        const learnerMarksRef = ref(database, `learners/${learnerKey}/marks/${examPeriod}`);

        set(learnerMarksRef, null)
          .then(() => {
            // Success toast
            Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'success',
              title: "Marks deleted successfully!",
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true
            });
            loadMarksFromFirebase();  // Refresh table
          })
          .catch(err => {
            console.error("Error deleting marks: ", err);
            // Error toast
            Swal.fire({
              toast: true,
              position: 'top-end',
              icon: 'error',
              title: "Failed to delete marks.",
              showConfirmButton: false,
              timer: 3000,
              timerProgressBar: true
            });
          });
      }
    });
  }
});

// Subject Champions button event  optionally toast if no selection
document.getElementById("subjectChampionsBtn").addEventListener("click", () => {
  const grade = document.getElementById("reportGradeSelect").value;
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!grade || !examPeriod) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select both grade and exam period first.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generateSubjectChampionsReport(grade, examPeriod);
});



document.getElementById("subjectPerformanceBtn").addEventListener("click", () => {
    const grade = document.getElementById("reportGradeSelect").value;
    const examPeriod = document.getElementById("reportExamPeriodSelect").value;
    generateSubjectPerformance(grade, examPeriod);
});

document.getElementById("genderPerformanceBtn").addEventListener("click", () => {
    const grade = document.getElementById("reportGradeSelect").value;
    const examPeriod = document.getElementById("reportExamPeriodSelect").value;
    generateGenderPerformance(grade, examPeriod);
});

document.getElementById("levelSummaryBtn").addEventListener("click", () => {
    const grade = document.getElementById("reportGradeSelect").value;
    const examPeriod = document.getElementById("reportExamPeriodSelect").value;
    generateLevelSummary(grade, examPeriod);
});

function generateSubjectChampionsReport(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const subjectKeys = [
        'eng', 'math', 'preTech',
        'kiswahili', 'science', 'social',
        'agriculture', 'cre', 'creativeArt'
    ];

    const champions = {};
    subjects.forEach(subject => {
        champions[subject] = { name: 'N/A', score: -1 };
    });

    // Filter and scan table rows
    marksTableBody.querySelectorAll("tr").forEach(row => {
        const grade = row.getAttribute("data-grade");
        const examPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && grade !== selectedGrade) return;
        if (selectedExamPeriod && examPeriod !== selectedExamPeriod) return;

        const learnerName = row.cells[1].textContent;

        subjectKeys.forEach((key, i) => {
            const score = parseFloat(row.cells[3 + i * 2].textContent);
            if (!isNaN(score) && score > champions[subjects[i]].score) {
                champions[subjects[i]] = { name: learnerName, score };
            }
        });
    });

    function getLevel(score) {
        if (score >= 90) return "EE 1";
        if (score >= 75) return "EE 2";
        if (score >= 58) return "ME 1";
        if (score >= 41) return "ME 2";
        if (score >= 31) return "AE 1";
        if (score >= 21) return "AE 2";
        if (score >= 11) return "BE 1";
        return "BE 2";
    }

    const sortedChampions = Object.entries(champions)
        .map(([subject, data]) => ({ subject, ...data }))
        .sort((a, b) => b.score - a.score);

    const top3 = sortedChampions.slice(0, 3);
    const year = new Date().getFullYear();

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL SUBJECT CHAMPIONS REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">Phone: +254-700-123456</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All Grades'}</p>
            <p style="margin: 5px 0;">Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 1px solid black; padding: 10px;">No.</th>
                    <th style="border: 1px solid black; padding: 10px;">Subject</th>
                    <th style="border: 1px solid black; padding: 10px;">Champion</th>
                    <th style="border: 1px solid black; padding: 10px;">Score</th>
                    <th style="border: 1px solid black; padding: 10px;">Performance Level</th>
                </tr>
            </thead>
            <tbody>`;

    let count = 1;
    sortedChampions.forEach(({ subject, name, score }) => {
        const level = getLevel(score);
        const isTop = top3.find(top => top.subject === subject);
        html += `<tr style="${isTop ? 'background: #FFD700; font-weight: bold;' : ''}">
            <td style="border: 1px solid black; padding: 10px;">${count++}</td>
            <td style="border: 1px solid black; padding: 10px;">${subject}</td>
            <td style="border: 1px solid black; padding: 10px;">${name}</td>
            <td style="border: 1px solid black; padding: 10px;">${score >= 0 ? score : 'N/A'}</td>
            <td style="border: 1px solid black; padding: 10px;">${level}</td>
        </tr>`;
    });

    html += `</tbody></table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    let printButton = document.getElementById("printSubjectChampionsBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printSubjectChampionsBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Subject Champions Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}

function generateLevelSummary(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const subjectKeys = [
        'engLev', 'mathLev', 'preTechLev',
        'kiswahiliLev', 'scienceLev', 'socialLev',
        'agricultureLev', 'creLev', 'creativeArtLev'
    ];

    const levels = ['EE 1', 'EE 2', 'ME 1', 'ME 2', 'AE 1', 'AE 2', 'BE 1', 'BE 2'];

    const summary = {};

    // Initialize summary counters
    subjects.forEach(subject => {
        summary[subject] = {};
        levels.forEach(level => summary[subject][level] = 0);
    });

    const marksTableBody = document.getElementById("marksList");

    // Process rows
    marksTableBody.querySelectorAll("tr").forEach(row => {
        const rowGrade = row.getAttribute("data-grade");
        const rowPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && rowGrade !== selectedGrade) return;
        if (selectedExamPeriod && rowPeriod !== selectedExamPeriod) return;

        subjectKeys.forEach((key, i) => {
            const level = row.querySelector(`td:nth-child(${4 + i * 2 + 1})`)?.textContent;
            if (levels.includes(level)) {
                summary[subjects[i]][level]++;
            }
        });
    });

    const year = new Date().getFullYear();

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL SUBJECT LEVEL SUMMARY REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">Phone: +254-700-123456</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All Grades'}</p>
            <p style="margin: 5px 0;">Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 1px solid black; padding: 10px;">Subject</th>`;

    levels.forEach(level => {
        html += `<th style="border: 1px solid black; padding: 10px;">${level}</th>`;
    });

    html += `</tr></thead><tbody>`;

    subjects.forEach(subject => {
        html += `<tr>
            <td style="border: 1px solid black; padding: 10px;">${subject}</td>`;
        levels.forEach(level => {
            html += `<td style="border: 1px solid black; padding: 10px;">${summary[subject][level]}</td>`;
        });
        html += `</tr>`;
    });

    html += `</tbody></table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    let printButton = document.getElementById("printLevelSummaryBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printLevelSummaryBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Subject Level Summary Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}



function showSubjectRanking(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const rankings = {};
    subjects.forEach(subject => rankings[subject] = []);

    const marksTableBody = document.getElementById("marksList");

    marksTableBody.querySelectorAll("tr").forEach(row => {
        const rowGrade = row.getAttribute("data-grade");
        const rowPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && rowGrade !== selectedGrade) return;
        if (selectedExamPeriod && rowPeriod !== selectedExamPeriod) return;

        const learnerName = row.cells[1].textContent;

        subjects.forEach((subject, i) => {
            const score = parseFloat(row.cells[3 + i * 2].textContent);
            if (!isNaN(score)) {
                rankings[subject].push({ name: learnerName, score });
            }
        });
    });

    // Sort rankings descending by score
    for (const subject in rankings) {
        rankings[subject].sort((a, b) => b.score - a.score);
    }

    function getPerformanceLevel(score) {
        if (score >= 90) return "EE 1";
        if (score >= 75) return "EE 2";
        if (score >= 58) return "ME 1";
        if (score >= 41) return "ME 2";
        if (score >= 31) return "AE 1";
        if (score >= 21) return "AE 2";
        if (score >= 11) return "BE 1";
        return "BE 2";
    }

    let rankingsHtml = `
        <div style="text-align: center; margin-bottom: 20px;">
            <h2 style="margin-bottom: 5px;">Subject Rankings</h2>
            <p style="margin: 0;">Grade: ${selectedGrade || 'All Grades'}</p>
            <p style="margin: 0;">Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
    `;

    for (const subject in rankings) {
        rankingsHtml += `
            <h4>${subject}</h4>
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background: #f2f2f2;">
                        <th style="border: 1px solid black; padding: 8px;">Rank</th>
                        <th style="border: 1px solid black; padding: 8px;">Name</th>
                        <th style="border: 1px solid black; padding: 8px;">Score</th>
                        <th style="border: 1px solid black; padding: 8px;">Performance Level</th>
                    </tr>
                </thead>
                <tbody>
        `;

        rankings[subject].forEach((entry, index) => {
            const level = getPerformanceLevel(entry.score);
            rankingsHtml += `
                <tr>
                    <td style="border: 1px solid black; padding: 8px;">${index + 1}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.name}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.score}</td>
                    <td style="border: 1px solid black; padding: 8px;">${level}</td>
                </tr>
            `;
        });

        rankingsHtml += `</tbody></table>`;
    }

    const reportDiv = document.getElementById("report");
    reportDiv.innerHTML = rankingsHtml;
}


function generateSubjectPerformance(selectedGrade, selectedExamPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const subjectKeys = [
        'eng', 'math', 'preTech',
        'kiswahili', 'science', 'social',
        'agriculture', 'cre', 'creativeArt'
    ];

    const subjectScores = {};
    const marksTableBody = document.getElementById("marksList");

    marksTableBody.querySelectorAll("tr").forEach(row => {
        const rowGrade = row.getAttribute("data-grade");
        const rowPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && rowGrade !== selectedGrade) return;
        if (selectedExamPeriod && rowPeriod !== selectedExamPeriod) return;

        subjectKeys.forEach((key, index) => {
            const score = parseFloat(row.cells[3 + index * 2].textContent);
            if (!isNaN(score)) {
                if (!subjectScores[subjects[index]]) {
                    subjectScores[subjects[index]] = { total: 0, count: 0 };
                }
                subjectScores[subjects[index]].total += score;
                subjectScores[subjects[index]].count++;
            }
        });
    });

    function getLevel(score) {
        if (score >= 90) return "EE 1";
        if (score >= 75) return "EE 2";
        if (score >= 58) return "ME 1";
        if (score >= 41) return "ME 2";
        if (score >= 31) return "AE 1";
        if (score >= 21) return "AE 2";
        if (score >= 11) return "BE 1";
        return "BE 2";
    }

    const meanScores = Object.keys(subjectScores).map(subject => {
        const { total, count } = subjectScores[subject];
        const mean = count > 0 ? (total / count).toFixed(2) : "0.00";
        return {
            subject,
            mean,
            level: getLevel(mean)
        };
    }).sort((a, b) => b.mean - a.mean);

    const topSubjects = meanScores.slice(0, 3);
    const year = new Date().getFullYear();

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL SUBJECT PERFORMANCE REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All Grades'}</p>
            <p style="margin: 5px 0;">Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 1px solid black; padding: 10px;">No.</th>
                    <th style="border: 1px solid black; padding: 10px;">Subject</th>
                    <th style="border: 1px solid black; padding: 10px;">Mean Score</th>
                    <th style="border: 1px solid black; padding: 10px;">Performance Level</th>
                </tr>
            </thead>
            <tbody>`;

    let count = 1;
    meanScores.forEach(({ subject, mean, level }) => {
        const isTop = topSubjects.find(top => top.subject === subject);
        html += `<tr style="${isTop ? 'background: #FFD700; font-weight: bold;' : ''}">
            <td style="border: 1px solid black; padding: 10px;">${count++}</td>
            <td style="border: 1px solid black; padding: 10px;">${subject}</td>
            <td style="border: 1px solid black; padding: 10px;">${mean}</td>
            <td style="border: 1px solid black; padding: 10px;">${level}</td>
        </tr>`;
    });

    html += `</tbody></table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    let printButton = document.getElementById("printSubjectPerformanceBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printSubjectPerformanceBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Subject Performance Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                            .stamp {
                                border: 2px solid blue;
                                color: blue;
                                text-align: center;
                                width: 200px;
                                height: 70px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 20px auto;
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                        <div class="stamp">
                            Nachu Junior School<br>
                            P.O. Box 561-00902<br>
                            Kikuyu...Exam Department
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}


function generateReport(reportType, selectedGrade, examPeriod) {
    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = ""; // Clear any existing content

    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];

    const levels = ['EE 1', 'EE 2', 'ME 1', 'ME 2', 'AE 1', 'AE 2', 'BE 1', 'BE 2'];

    const summary = {};

    // Initialize summary counters (if applicable for this report type)
    if (reportType === 'subjectChampions' || reportType === 'levelSummary') {
        subjects.forEach(subject => {
            summary[subject] = {};
            levels.forEach(level => summary[subject][level] = 0);
        });
    }

    // Process rows (e.g., marks table or database rows)
    marksTableBody.querySelectorAll("tr").forEach(row => {
        if (selectedGrade && row.getAttribute("data-grade") !== selectedGrade) return;
        if (examPeriod && row.getAttribute("data-period") !== examPeriod) return;

        // Example: Populate summary based on report type
        if (reportType === 'levelSummary') {
            subjects.forEach((subject, i) => {
                const level = row.querySelector(`td:nth-child(${4 + i * 2 + 1})`)?.textContent;
                if (levels.includes(level)) {
                    summary[subject][level]++;
                }
            });
        }

        // Add other report-specific data processing logic here
    });

    // Generate HTML
    const year = new Date().getFullYear();
    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All'}</p>
            <p style="margin: 5px 0;">Exam Period: ${examPeriod || 'All'}</p>
        </div>`;

    // Add table for level summary
    if (reportType === 'levelSummary') {
        html += `<table style="width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 1px solid black; padding: 10px;">Subject</th>`;
        levels.forEach(level => {
            html += `<th style="border: 1px solid black; padding: 10px;">${level}</th>`;
        });
        html += `</tr></thead><tbody>`;

        subjects.forEach(subject => {
            html += `<tr>
                <td style="border: 1px solid black; padding: 10px;">${subject}</td>`;
            levels.forEach(level => {
                html += `<td style="border: 1px solid black; padding: 10px;">${summary[subject][level]}</td>`;
            });
            html += `</tr>`;
        });

        html += `</tbody></table>`;
    }

    // Add other report-specific HTML here (e.g., charts, summaries, etc.)

    reportOutput.innerHTML = html;

    // Add Print Button
    let printButton = document.getElementById("printReportBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printReportBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>${reportType} Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                            .stamp {
                                border: 2px solid blue;
                                color: blue;
                                text-align: center;
                                width: 200px;
                                height: 70px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                margin: 20px auto;
                                font-weight: bold;
                            }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                        <div class="stamp">
                            Nachu Junior School<br>
                            P.O. Box 561-00902<br>
                            Kikuyu...Exam Department
                        </div>
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}
function generateGenderPerformance(selectedGrade, selectedExamPeriod) {
    function getLevel(score) {
        if (score >= 90) return "EE 1";
        if (score >= 75) return "EE 2";
        if (score >= 58) return "ME 1";
        if (score >= 41) return "ME 2";
        if (score >= 31) return "AE 1";
        if (score >= 21) return "AE 2";
        if (score >= 11) return "BE 1";
        return "BE 2";
    }

    const learnersData = [];
    const subjectTotals = {
        Eng: 0, Math: 0, PreTech: 0, Kiswahili: 0, Science: 0,
        Social: 0, Agric: 0, CRE: 0, CreativeArt: 0,
    };
    let grandTotalMarks = 0;
    let totalLearners = 0;

    const marksTableBody = document.getElementById("marksList");

    marksTableBody.querySelectorAll("tr").forEach(row => {
        const rowGrade = row.getAttribute("data-grade");
        const rowPeriod = row.getAttribute("data-exam-period");

        if (selectedGrade && rowGrade !== selectedGrade) return;
        if (selectedExamPeriod && rowPeriod !== selectedExamPeriod) return;

        const learnerName = row.cells[1].textContent;
        const learnerScores = {
            Eng: parseFloat(row.cells[3].textContent) || 0,
            Math: parseFloat(row.cells[5].textContent) || 0,
            PreTech: parseFloat(row.cells[7].textContent) || 0,
            Kiswahili: parseFloat(row.cells[9].textContent) || 0,
            Science: parseFloat(row.cells[11].textContent) || 0,
            Social: parseFloat(row.cells[13].textContent) || 0,
            Agric: parseFloat(row.cells[15].textContent) || 0,
            CRE: parseFloat(row.cells[17].textContent) || 0,
            CreativeArt: parseFloat(row.cells[19].textContent) || 0,
        };

        const learnerLevels = {};
        let totalMarks = 0;

        for (const [subject, score] of Object.entries(learnerScores)) {
            learnerLevels[subject] = getLevel(score);
            subjectTotals[subject] += score;
            totalMarks += score;
        }

        grandTotalMarks += totalMarks;
        totalLearners++;

        learnersData.push({
            name: learnerName,
            grade: rowGrade,
            scores: learnerScores,
            levels: learnerLevels,
            total: totalMarks
        });
    });

    const subjectAverages = {};
    for (const subject in subjectTotals) {
        subjectAverages[subject] = totalLearners > 0
            ? (subjectTotals[subject] / totalLearners).toFixed(2)
            : "0.00";
    }

    const averageTotalMarks = totalLearners > 0
        ? (grandTotalMarks / totalLearners).toFixed(2)
        : "0.00";

    const year = new Date().getFullYear();

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL GENDER PERFORMANCE REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">Phone: +254-700-123456</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All Grades'}</p>
            <p style="margin: 5px 0;">Exam Period: ${selectedExamPeriod || 'All Periods'}</p>
        </div>
        <table style="width: 100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 1px solid black; padding: 10px;">No.</th>
                    <th style="border: 1px solid black; padding: 10px;">Name</th>
                    <th style="border: 1px solid black; padding: 10px;">Grade</th>
                    ${["Eng", "Math", "PreTech", "Kiswahili", "Science", "Social", "Agric", "CRE", "CreativeArt"].map(sub =>
                        `<th style="border: 1px solid black; padding: 10px;">${sub}</th>
                         <th style="border: 1px solid black; padding: 10px;">Lev</th>`).join("")}
                    <th style="border: 1px solid black; padding: 10px;">Total Mark</th>
                </tr>
            </thead>
            <tbody>`;

    learnersData.forEach((learner, index) => {
        html += `<tr>
            <td style="border: 1px solid black; padding: 10px;">${index + 1}</td>
            <td style="border: 1px solid black; padding: 10px;">${learner.name}</td>
            <td style="border: 1px solid black; padding: 10px;">${learner.grade}</td>`;
        for (const subject of Object.keys(learner.scores)) {
            html += `<td style="border: 1px solid black; padding: 10px;">${learner.scores[subject]}</td>
                     <td style="border: 1px solid black; padding: 10px;">${learner.levels[subject]}</td>`;
        }
        html += `<td style="border: 1px solid black; padding: 10px;">${learner.total}</td></tr>`;
    });

    // Totals row
    html += `<tr style="font-weight: bold; background-color: #f9f9f9;">
        <td colspan="3" style="border: 1px solid black; padding: 10px; text-align: center;">Totals</td>`;
    for (const subject of Object.keys(subjectTotals)) {
        html += `<td style="border: 1px solid black; padding: 10px;">${subjectTotals[subject]}</td><td></td>`;
    }
    html += `<td style="border: 1px solid black; padding: 10px;">${grandTotalMarks}</td></tr>`;

    // Averages row
    html += `<tr style="font-weight: bold; background-color: #f2f2f2;">
        <td colspan="3" style="border: 1px solid black; padding: 10px; text-align: center;">Averages</td>`;
    for (const subject of Object.keys(subjectAverages)) {
        html += `<td style="border: 1px solid black; padding: 10px;">${subjectAverages[subject]}</td><td></td>`;
    }
    html += `<td style="border: 1px solid black; padding: 10px;">${averageTotalMarks}</td></tr>`;

    html += `</tbody></table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    let printButton = document.getElementById("printGenderPerformanceBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printGenderPerformanceBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Gender Performance Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}


document.getElementById("generateAssessmentReportsBtn").addEventListener("click", function () {
    const grade = document.getElementById("reportGradeSelect").value;

    // Handle missing grade selection
    if (!grade || grade === "Select Grade") {
        createCustomAlert(
            "Oops! You forgot to select a grade. Please choose a grade from the dropdown before generating the assessment reports.",
            "#f8d7da",
            "#721c24"
        );
        return;
    }

    // Collect term details from form inputs
    const year = document.getElementById("year").value.trim();
    const term = document.getElementById("term").value.trim();
    const closingDate = document.getElementById("closingDate").value.trim();
    const openingDate = document.getElementById("openingDate").value.trim();
    const classTeacherSignature = document.getElementById("classTeacherSignature").value.trim();
    const principalSignature = document.getElementById("principalSignature").value.trim();

    // Handle missing term details
    if (!year || !term || !closingDate || !openingDate || !classTeacherSignature || !principalSignature) {
        createCustomAlert(
            "Please fill in all the term details before generating the reports.",
            "#ffeeba",
            "#856404"
        );
        return;
    }

    // Pass term details and selected grade to the report generator
    const termDetails = { year, term, closingDate, openingDate, classTeacherSignature, principalSignature };
    generateLearnerAssessmentReports(termDetails, grade); // Pass grade for filtered reports
});

/**
 * Creates a custom alert.
 * @param {string} message - The alert message to display.
 * @param {string} bgColor - The background color for the alert.
 * @param {string} textColor - The text color for the alert.
 */
function createCustomAlert(message, bgColor, textColor) {
    // Create the custom alert element
    const customAlert = document.createElement("div");
    customAlert.style.display = "flex";
    customAlert.style.flexDirection = "column";
    customAlert.style.alignItems = "center";
    customAlert.style.position = "fixed";
    customAlert.style.top = "50%";
    customAlert.style.left = "50%";
    customAlert.style.transform = "translate(-50%, -50%)";
    customAlert.style.backgroundColor = bgColor;
    customAlert.style.color = textColor;
    customAlert.style.padding = "20px";
    customAlert.style.borderRadius = "10px";
    customAlert.style.boxShadow = "0 4px 10px rgba(0, 0, 0, 0.2)";
    customAlert.style.zIndex = "9999";
    customAlert.style.width = "90%";
    customAlert.style.maxWidth = "400px";

    // Add the alert message
    const alertMessage = document.createElement("span");
    alertMessage.style.textAlign = "center";
    alertMessage.style.marginBottom = "10px";
    alertMessage.textContent = message;
    customAlert.appendChild(alertMessage);

    // Add a close button
    const closeButton = document.createElement("button");
    closeButton.textContent = "Close";
    closeButton.style.marginTop = "10px";
    closeButton.style.backgroundColor = textColor;
    closeButton.style.color = "white";
    closeButton.style.border = "none";
    closeButton.style.padding = "10px 20px";
    closeButton.style.borderRadius = "5px";
    closeButton.style.cursor = "pointer";
    closeButton.addEventListener("click", function () {
        document.body.removeChild(customAlert); // Remove the alert on click
    });
    customAlert.appendChild(closeButton);

    // Append the custom alert to the body
    document.body.appendChild(customAlert);
}

function generateLearnerAssessmentReports(termDetails) {
    const { year, term, closingDate, openingDate, classTeacherSignature, principalSignature } = termDetails;

    const rows = document.querySelectorAll("#marksList tr");
    const learnerRows = document.querySelectorAll("#learnersList tr");
    const container = document.getElementById("assessmentReportsContainer");
    container.innerHTML = "";

    const govtLogo = "https://i.imgur.com/KkbIFjL.png";
    const schoolLogo = "https://i.imgur.com/UW65hfv.png";
    const date = new Date().toLocaleDateString("en-GB");

    const gradeFilter = document.getElementById("reportGradeSelect").value;

    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        if (cells.length < 22) return;

        const learnerName = cells[1].textContent.trim();
        const grade = cells[2].textContent.trim();

        // ? Filter by selected grade
        if (grade !== gradeFilter) return;

        const totalMarks = cells[21].textContent.trim();
        const performance = getPerformanceLevel(totalMarks);

        let learnerPhoto = "";
        learnerRows.forEach(lr => {
            if (lr.cells[2]?.textContent.trim() === learnerName) {
                const imgTag = lr.querySelector("img");
                learnerPhoto = imgTag ? imgTag.src : "";
            }
        });

        const subjects = [
            { name: "English", mark: cells[3].textContent, level: cells[4].textContent },
            { name: "Mathematics", mark: cells[5].textContent, level: cells[6].textContent },
            { name: "Pre-Technical Studies", mark: cells[7].textContent, level: cells[8].textContent },
            { name: "Kiswahili", mark: cells[9].textContent, level: cells[10].textContent },
            { name: "Integrated Science", mark: cells[11].textContent, level: cells[12].textContent },
            { name: "Social Studies", mark: cells[13].textContent, level: cells[14].textContent },
            { name: "Agriculture", mark: cells[15].textContent, level: cells[16].textContent },
            { name: "Religious Education", mark: cells[17].textContent, level: cells[18].textContent },
            { name: "Creative Arts & Sports", mark: cells[19].textContent, level: cells[20].textContent },
        ];

        const report = document.createElement("div");
        report.style.pageBreakAfter = "always";
        report.style.border = "3px solid #000";
        report.style.padding = "20px";
        report.style.marginBottom = "30px";
        report.style.background = "#fff";

        report.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <img src="${govtLogo}" alt="Gov Logo" style="height: 80px;">
                <div style="text-align: center; flex-grow: 1;">
                    <h2 style="margin: 0;">NACHU JUNIOR SCHOOL</h2>
                    <p style="margin: 2px;">PO BOX 561-00902 KIKUYU, KENYA</p>
                    <p style="margin: 2px;">MINISTRY OF EDUCATION SCIENCE AND TECHNOLOGY</p>
                    <strong style="font-size: 14px;">SCHOOL MOTTO: HARD WORK PAYS</strong>
                </div>
                <img src="${schoolLogo}" alt="School Logo" style="height: 80px;">
            </div>

            <hr style="margin: 10px 0;">

            <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                <div style="flex: 1;">
                    <p><strong>GRADE:</strong> ${grade} &emsp; <strong>TERM:</strong> ${term} &emsp; <strong>YEAR:</strong> ${year}</p>
                    <p><strong>Learner's Name:</strong> ${learnerName}</p>
                </div>
                <div>
                    ${learnerPhoto ? `<img src="${learnerPhoto}" alt="Learner Photo" style="height: 100px; border-radius: 10px; border: 1px solid #333;">` : ""}
                </div>
            </div>

            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background: #f2f2f2;">
                        <th style="border: 3px solid #000; padding: 8px;">Subject</th>
                        <th style="border: 3px solid #000; padding: 8px;">Score</th>
                        <th style="border: 3px solid #000; padding: 8px;">Level</th>
                        <th style="border: 3px solid #000; padding: 8px;">Subject Teacher</th>
                        <th style="border: 3px solid #000; padding: 8px;">Signature</th>
                    </tr>
                </thead>
                <tbody>
                    ${subjects.map(sub => `
                        <tr>
                            <td style="border: 3px solid #000; padding: 8px;">${sub.name}</td>
                            <td style="border: 3px solid #000; padding: 8px;">${sub.mark}</td>
                            <td style="border: 3px solid #000; padding: 8px;">${sub.level}</td>
                            <td style="border: 3px solid #000; padding: 8px;">${subjectTeachers[sub.name] || "N/A"}</td>
                            <td style="border: 3px solid #000; padding: 8px;">${getInitials(subjectTeachers[sub.name]) || "N/A"}</td>
                        </tr>
                    `).join("")}
                </tbody>
            </table>

            <p style="margin-top: 15px;"><strong>Total Marks:</strong> ${totalMarks}</p>
            <p style="font-size: 14px;"><strong>KEY:</strong> 1 BE, 2 AE, 3 ME, 4 EE</p>

            <p><strong>Teacher Comments:</strong><br>${getComment(totalMarks)}</p>

            <p><strong>Learner's General Performance Level:</strong> ${performance}</p>

            <div style="margin-top: 20px;">
                <p><strong>CLOSING DATE:</strong> ${closingDate} &emsp; <strong>OPENING DATE:</strong> ${openingDate}</p>
                <p><strong>Class Teacher Signature:</strong> ${classTeacherSignature} &emsp; <strong>Principal Signature:</strong> ${principalSignature}</p>

                <div style="border: 2px solid blue; color: blue; padding: 10px; display: inline-block; text-align: center; font-style: italic; font-weight: bold; border-radius: 5px;">
                    Nachu Junior School<br>
                    P.O. Box 561-00902 Kikuyu<br>
                    Date: ${date}
                </div>
            </div>
        `;

        container.appendChild(report);
    });

    // Add Print Button
    const printButton = document.createElement("button");
    printButton.textContent = `Print Reports for ${selectedGrade || "All Grades"}`;
    printButton.style.marginTop = "20px";
    printButton.style.padding = "10px 20px";
    printButton.style.background = "#007BFF";
    printButton.style.color = "#FFF";
    printButton.style.border = "none";
    printButton.style.borderRadius = "5px";
    printButton.style.cursor = "pointer";

    printButton.addEventListener("click", function () {
        const printContent = container.innerHTML;
        const originalContent = document.body.innerHTML;

        document.body.innerHTML = printContent;
        window.print();
        document.body.innerHTML = originalContent;
        location.reload(); // Reload to reset the page
    });

    container.appendChild(printButton);
    container.scrollIntoView({ behavior: "smooth" });
}


const subjectList = [
    "English", "Mathematics", "Pre-Technical Studies", "Kiswahili",
    "Integrated Science", "Social Studies", "Agriculture",
    "Religious Education", "Creative Arts & Sports"
];
let subjectTeachers = {};

document.getElementById("generateAssessmentReportsBtn").addEventListener("click", showTeacherModal);

function showTeacherModal() {
    const modal = document.getElementById("teacherModal");
    const inputArea = document.getElementById("teacherInputs");
    inputArea.innerHTML = "";

    // Add inputs for subject teachers
    subjectList.forEach(subject => {
        inputArea.innerHTML += `
            <div class="form-group">
                <label for="${subject}">${subject} Teacher</label>
                <input type="text" id="${subject}" name="${subject}" required>
            </div>`;
    });

    // Add inputs for term details
    inputArea.innerHTML += `
        <div class="form-group">
 
        </div>
        <div class="form-group">
            
        </div>`;
    
    modal.style.display = "flex";
}

document.getElementById("teacherForm").addEventListener("submit", function (e) {
    e.preventDefault();

    // Collect subject teachers
    subjectTeachers = {};
    subjectList.forEach(subject => {
        const value = document.getElementById(subject).value.trim();
        subjectTeachers[subject] = value || "N/A";
    });

    // Collect term details
    const year = document.getElementById("year").value.trim();
    const term = document.getElementById("term").value.trim();
    const closingDate = document.getElementById("closingDate").value.trim();
    const openingDate = document.getElementById("openingDate").value.trim();
    const classTeacherSignature = document.getElementById("classTeacherSignature").value.trim();
    const principalSignature = document.getElementById("principalSignature").value.trim();

    // Validation for term details
    if (!year || !term || !closingDate || !openingDate || !classTeacherSignature || !principalSignature) {
        alert("Please fill in all required fields.");
        return;
    }

    // Create term details object
    const termDetails = { year, term, closingDate, openingDate, classTeacherSignature, principalSignature };

    closeTeacherModal();

    // Generate reports with both teacher and term details
    generateLearnerAssessmentReports(termDetails);
});

function closeTeacherModal() {
    document.getElementById("teacherModal").style.display = "none";
}


function getInitials(name) {
    return name
        .split(" ")
        .filter(Boolean)
        .map(word => word.charAt(0).toUpperCase())
        .join("");
}
function getPerformanceLevel(totalMarks) {
    if (totalMarks >= 1 && totalMarks <= 200) return "Below expectations";
    if (totalMarks >= 201 && totalMarks <= 400) return "Approaching expectations";
    if (totalMarks >= 401 && totalMarks <= 600) return "Meeting expectations";
    if (totalMarks >= 601 && totalMarks <= 800) return "Exceeding expectations";
    return "";
}

 function getComment(totalMarks) {
           if (totalMarks >= 0 && totalMarks <= 20) 
    return "Needs significant improvement. Should seek help and put in extra effort.";
if (totalMarks >= 21 && totalMarks <= 30) 
    return "Shows some understanding but needs to work harder and focus on their studies.";
if (totalMarks >= 31 && totalMarks <= 50) 
    return "Displays potential but requires more dedication to reach higher performance.";
if (totalMarks >= 51 && totalMarks <= 70) 
    return "Making steady progress. Should maintain focus to improve further.";
if (totalMarks >= 71 && totalMarks <= 85) 
    return "Demonstrates good understanding but should aim for consistent excellence.";
if (totalMarks >= 86 && totalMarks <= 140) 
    return "Shows dedication and effort but can aim for even higher performance.";
if (totalMarks >= 141 && totalMarks <= 199) 
    return "Displays self-discipline; however, should put extra effort to achieve higher scores.";
if (totalMarks >= 200 && totalMarks <= 205)  
    return "Shows enthusiasm for learning but needs to focus on grasping foundational concepts. Encouraged to seek clarification when in doubt.";  
if (totalMarks >= 206 && totalMarks <= 215)  
    return "Demonstrates interest in academics but requires more consistency in applying knowledge. Should practice regularly to build confidence.";  
if (totalMarks >= 216 && totalMarks <= 225)  
    return "Has potential to improve but needs to work on time management and study habits. Encouraged to engage more in revision and discussions.";  
if (totalMarks >= 226 && totalMarks <= 235)  
    return "Engages with class activities but should refine problem-solving techniques. Needs to develop a structured approach to answering questions.";  
if (totalMarks >= 236 && totalMarks <= 245)  
    return "Displays curiosity and willingness to learn but struggles with applying concepts. Should focus on understanding rather than memorization.";  
if (totalMarks >= 246 && totalMarks <= 255)  
    return "Puts in effort but must aim for greater accuracy in assignments and tests. Reviewing mistakes carefully will enhance performance.";  
if (totalMarks >= 256 && totalMarks <= 265)  
    return "Shows eagerness to learn but needs to work on building confidence when answering questions. Should participate more in class discussions.";  
if (totalMarks >= 266 && totalMarks <= 275)  
    return "Participates in class activities but requires a stronger grasp of core subjects. Encouraged to ask more questions and seek additional resources.";  
if (totalMarks >= 276 && totalMarks <= 285)  
    return "Makes steady progress and shows improvement in understanding concepts. Should challenge themselves further by attempting advanced problems.";  
if (totalMarks >= 286 && totalMarks <= 295)  
    return "Displays motivation and a desire to improve. Needs to focus on critical thinking and applying knowledge to real-world scenarios.";  
if (totalMarks >= 296 && totalMarks <= 300)  
    return "Committed to learning and shows perseverance. Should refine study techniques for better retention and comprehension.";  
if (totalMarks >= 301 && totalMarks <= 350)  
    return "Actively participates in class discussions and collaborates well with peers. Demonstrates growing confidence in expressing ideas.";  
if (totalMarks >= 351 && totalMarks <= 400)  
    return "Shows steady academic progress and a willingness to learn. Encouraged to maintain a consistent study schedule to reinforce learning.";  
if (totalMarks >= 401 && totalMarks <= 449)  
    return "Consistently performs above expectations, demonstrating strong analytical and problem-solving skills. A well-rounded student.";  
if (totalMarks >= 450 && totalMarks <= 500)  
    return "Exhibits leadership qualities and a solid grasp of concepts. Should continue exploring challenging material to push beyond comfort zones.";  
if (totalMarks >= 501 && totalMarks <= 550)  
    return "A high-achieving student who takes initiative in group discussions. Sets a great example for peers through disciplined study habits.";  
if (totalMarks >= 551 && totalMarks <= 599)  
    return "Excels academically and demonstrates a strong ability to grasp new concepts. Should continue nurturing curiosity and exploring deeper learning.";  
if (totalMarks >= 600 && totalMarks <= 630)  
    return "A highly motivated learner who consistently delivers outstanding results. Shows great potential for further academic excellence.";  
if (totalMarks >= 631 && totalMarks <= 670)  
    return "Displays deep subject mastery and strong analytical skills. Should take on advanced challenges to further enhance learning.";  
if (totalMarks >= 671 && totalMarks <= 700)  
    return "Demonstrates critical thinking and a keen ability to apply knowledge. Shows promise in problem-solving and independent learning.";  
if (totalMarks >= 701 && totalMarks <= 750)  
    return "Achieves remarkable academic performance with a strong work ethic. Should continue to challenge themselves with complex concepts.";  
if (totalMarks >= 751 && totalMarks <= 800)  
    return "Displays outstanding problem-solving skills and an in-depth understanding of subjects. A top performer with great potential.";  
if (totalMarks >= 801 && totalMarks <= 850)  
    return "Excels in all areas and consistently exceeds expectations. Should consider mentoring peers to reinforce knowledge.";  
if (totalMarks >= 851 && totalMarks <= 900)  
    return "An exceptional learner who sets a high standard for academic excellence. Demonstrates leadership, discipline, and an advanced understanding of concepts.";  
return "";


}
document.getElementById("combineMarksByGradeBtn").addEventListener("click", () => {
    document.getElementById("customPrompt").style.display = "flex";
    document.getElementById("gradeInput").value = ""; // clear any previous input
    document.getElementById("gradeInput").focus();
});

document.getElementById("confirmGradeBtn").addEventListener("click", () => {
  const selectedGrade = document.getElementById("gradeInput").value.trim();
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!selectedGrade) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please enter a valid grade.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  if (!examPeriod || examPeriod === "Select Exam Period") {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select a valid exam period.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  document.getElementById("customPrompt").style.display = "none";
  combineMarksByGradeWithDetails(selectedGrade, examPeriod);
});


document.getElementById("cancelGradeBtn").addEventListener("click", () => {
    document.getElementById("customPrompt").style.display = "none";
});
function combineMarksByGradeWithDetails(mainGrade, selectedPeriod) {
    const rows = document.querySelectorAll("#marksList tr");
    const learnersData = [];
    const totals = {
        eng: 0, math: 0, preTech: 0, kiswahili: 0,
        science: 0, social: 0, agriculture: 0, cre: 0, creativeArt: 0, totalMarks: 0
    };
    let learnerCount = 0;

    // Collect data for learners in the specified grade and period
    rows.forEach(row => {
        const cells = row.querySelectorAll("td");
        const grade = cells[2].textContent.trim();
        const period = row.getAttribute("data-exam-period");

        if (grade.startsWith(mainGrade) && period === selectedPeriod) {
            const engScore = parseFloat(cells[3].textContent) || 0;
            const mathScore = parseFloat(cells[5].textContent) || 0;
            const preTechScore = parseFloat(cells[7].textContent) || 0;
            const kiswahiliScore = parseFloat(cells[9].textContent) || 0;
            const scienceScore = parseFloat(cells[11].textContent) || 0;
            const socialScore = parseFloat(cells[13].textContent) || 0;
            const agricultureScore = parseFloat(cells[15].textContent) || 0;
            const creScore = parseFloat(cells[17].textContent) || 0;
            const creativeArtScore = parseFloat(cells[19].textContent) || 0;

            const learnerData = {
                name: cells[1].textContent.trim(),
                grade,
                eng: engScore,
                math: mathScore,
                preTech: preTechScore,
                kiswahili: kiswahiliScore,
                science: scienceScore,
                social: socialScore,
                agriculture: agricultureScore,
                cre: creScore,
                creativeArt: creativeArtScore,
                engLevel: getLevel(engScore),
                mathLevel: getLevel(mathScore),
                preTechLevel: getLevel(preTechScore),
                kiswahiliLevel: getLevel(kiswahiliScore),
                scienceLevel: getLevel(scienceScore),
                socialLevel: getLevel(socialScore),
                agricultureLevel: getLevel(agricultureScore),
                creLevel: getLevel(creScore),
                creativeArtLevel: getLevel(creativeArtScore),
            };

            learnerData.totalMarks = Object.values(learnerData).slice(2, 11).reduce((sum, mark) => sum + mark, 0);
            learnersData.push(learnerData);

            // Update totals
            totals.eng += engScore;
            totals.math += mathScore;
            totals.preTech += preTechScore;
            totals.kiswahili += kiswahiliScore;
            totals.science += scienceScore;
            totals.social += socialScore;
            totals.agriculture += agricultureScore;
            totals.cre += creScore;
            totals.creativeArt += creativeArtScore;
            totals.totalMarks += learnerData.totalMarks;

            learnerCount++;
        }
    });
if (learnersData.length === 0) {
  Swal.fire({
    toast: true,
    position: 'top-end',
    icon: 'info',
    title: `No data found for grade ${mainGrade} and period ${selectedPeriod}.`,
    showConfirmButton: false,
    timer: 3000,
    timerProgressBar: true
  });
  return;
}


    const year = new Date().getFullYear();
    const avg = val => (learnerCount ? (val / learnerCount).toFixed(2) : "0.00");

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
           <h2 style="margin: 0;">NACHU JUNIOR SCHOOL COMBINED MARKS REPORT</h2>
            <p>Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p>School Motto: "Excellence Through Knowledge"</p>
            <p>Year: ${year}</p>
            <p>Grade: ${mainGrade}</p>
            <p>Exam Period: ${selectedPeriod}</p>
        </div>

        <table style="width: 100%; border-collapse: collapse; font-size: 15px;">
            <thead>
                <tr style="background: #f2f2f2;">
                    <th style="border: 1px solid black;">No.</th>
                    <th style="border: 1px solid black;">Name</th>
                    <th style="border: 1px solid black;">Grade</th>
                    <th style="border: 1px solid black;">English</th><th>Level</th>
                    <th style="border: 1px solid black;">Math</th><th>Level</th>
                    <th style="border: 1px solid black;">Pre-Tech</th><th>Level</th>
                    <th style="border: 1px solid black;">Kiswahili</th><th>Level</th>
                    <th style="border: 1px solid black;">Science</th><th>Level</th>
                    <th style="border: 1px solid black;">Social</th><th>Level</th>
                    <th style="border: 1px solid black;">Agriculture</th><th>Level</th>
                    <th style="border: 1px solid black;">CRE</th><th>Level</th>
                    <th style="border: 1px solid black;">Creative Art</th><th>Level</th>
                    <th style="border: 1px solid black;">Total</th>
                </tr>
            </thead>
            <tbody>`;

    learnersData.forEach((l, i) => {
        html += `
            <tr>
                <td>${i + 1}</td><td>${l.name}</td><td>${l.grade}</td>
                <td>${l.eng}</td><td>${l.engLevel}</td>
                <td>${l.math}</td><td>${l.mathLevel}</td>
                <td>${l.preTech}</td><td>${l.preTechLevel}</td>
                <td>${l.kiswahili}</td><td>${l.kiswahiliLevel}</td>
                <td>${l.science}</td><td>${l.scienceLevel}</td>
                <td>${l.social}</td><td>${l.socialLevel}</td>
                <td>${l.agriculture}</td><td>${l.agricultureLevel}</td>
                <td>${l.cre}</td><td>${l.creLevel}</td>
                <td>${l.creativeArt}</td><td>${l.creativeArtLevel}</td>
                <td>${l.totalMarks}</td>
            </tr>`;
    });

    // Add totals row
    html += `
        <tr style="background: #e6f7ff; font-weight: bold;">
            <td colspan="3">TOTAL</td>
            <td>${totals.eng}</td><td></td>
            <td>${totals.math}</td><td></td>
            <td>${totals.preTech}</td><td></td>
            <td>${totals.kiswahili}</td><td></td>
            <td>${totals.science}</td><td></td>
            <td>${totals.social}</td><td></td>
            <td>${totals.agriculture}</td><td></td>
            <td>${totals.cre}</td><td></td>
            <td>${totals.creativeArt}</td><td></td>
            <td>${totals.totalMarks}</td>
        </tr>
        <tr style="background: #fcf8e3; font-weight: bold;">
            <td colspan="3">AVERAGE</td>
            <td>${avg(totals.eng)}</td><td></td>
            <td>${avg(totals.math)}</td><td></td>
            <td>${avg(totals.preTech)}</td><td></td>
            <td>${avg(totals.kiswahili)}</td><td></td>
            <td>${avg(totals.science)}</td><td></td>
            <td>${avg(totals.social)}</td><td></td>
            <td>${avg(totals.agriculture)}</td><td></td>
            <td>${avg(totals.cre)}</td><td></td>
            <td>${avg(totals.creativeArt)}</td><td></td>
            <td>${avg(totals.totalMarks)}</td>
        </tr>`;

    html += `</tbody></table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    // Add Print Button
    let printButton = document.getElementById("printCombinedMarksBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printCombinedMarksBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Combined Marks Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}




const filterGender = document.getElementById('filterGender');

filterGender.addEventListener('change', () => {
  const selectedGender = filterGender.value;
  const rows = tableBody.querySelectorAll('tr');

  rows.forEach(row => {
    const learnerGender = row.cells[3].textContent.trim();
    if (selectedGender === "" || learnerGender === selectedGender) {
      row.style.display = "";
    } else {
      row.style.display = "none";
    }
  });
});
document.getElementById("printGroupedByGenderButton").addEventListener("click", () => {
  const schoolName = "Your School Name";
  const year = "2025";
  const term = "Term 1";
  const selectedGender = filterGender.value;

  const learners = [];

  tableBody.querySelectorAll("tr").forEach(row => {
    const learnerGender = row.cells[3].textContent.trim();

    // If a gender is selected, skip rows not matching it
    if (selectedGender && learnerGender !== selectedGender) return;

    const learner = {
      name: row.cells[2].textContent,
      gender: learnerGender,
      grade: row.cells[4].textContent,
      age: row.cells[5].textContent,
      parentName: row.cells[6].textContent,
      phone: row.cells[7].textContent,
      birthCertificateNo: row.cells[8].textContent,
      admissionNumber: row.cells[9].textContent,
      photo: row.cells[1].querySelector("img").src
    };

    learners.push(learner);
  });

  if (learners.length === 0) {
    alert("No learners found for the selected gender.");
    return;
  }

  printLearnersByGender(schoolName, year, term, selectedGender, learners);
});
function printLearnersByGender(schoolName, year, term, gender, learners) {
  const logoUrl = "https://i.imgur.com/UW65hfv.png";

  const tableHtml = `
    <h3 style="margin-top:30px;">${gender ? gender : "All Learners"}</h3>
    <table class="learners-table" style="width:100%; border-collapse: collapse;">
      <thead>
        <tr>
          <th style="border: 1px solid black;">No.</th>
          <th style="border: 1px solid black;">Photo</th>
          <th style="border: 1px solid black;">Name</th>
          <th style="border: 1px solid black;">Grade</th>
          <th style="border: 1px solid black;">Age</th>
          <th style="border: 1px solid black;">Parent Name</th>
          <th style="border: 1px solid black;">Phone</th>
          <th style="border: 1px solid black;">Birth Cert No</th>
          <th style="border: 1px solid black;">Admission No</th>
        </tr>
      </thead>
      <tbody>
        ${learners.map((l, i) => `
          <tr>
            <td style="border: 1px solid black;">${i + 1}</td>
            <td style="border: 1px solid black;"><img src="${l.photo}" alt="Photo" width="50" height="50"></td>
            <td style="border: 1px solid black;">${l.name}</td>
            <td style="border: 1px solid black;">${l.grade}</td>
            <td style="border: 1px solid black;">${l.age}</td>
            <td style="border: 1px solid black;">${l.parentName}</td>
            <td style="border: 1px solid black;">${l.phone}</td>
            <td style="border: 1px solid black;">${l.birthCertificateNo}</td>
            <td style="border: 1px solid black;">${l.admissionNumber}</td>
          </tr>`).join("")}
      </tbody>
    </table>`;

  const printWindow = window.open("", "_blank");
  printWindow.document.write(`
    <html>
      <head>
        <title>${gender ? gender : "Learners"} List</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; }
          h3 { text-align: left; margin-bottom: 5px; }
          table { margin-top: 10px; }
          .learners-table th, .learners-table td { border: 1px solid black; padding: 8px; text-align: center; }
        </style>
      </head>
      <body>
        <div>
          <img src="${logoUrl}" alt="Logo" style="height:50px;">
          <h2 style="display:inline-block; margin-left:10px;">${schoolName}</h2>
          <p><strong>Year:</strong> ${year} &nbsp;&nbsp; <strong>Term:</strong> ${term}</p>
        </div>
        ${tableHtml}
      </body>
    </html>
  `);
  printWindow.document.close();
  printWindow.print();
}
// Populate grade dropdown from existing grades
onValue(learnersRef, (snapshot) => {
    const classListGradeSelect = document.getElementById("classListGradeSelect");
    const grades = new Set();
    snapshot.forEach(childSnapshot => {
        const data = childSnapshot.val();
        grades.add(data.grade);
    });

    classListGradeSelect.innerHTML = `<option value="">Select Grade</option>`;
    grades.forEach(grade => {
        const option = document.createElement("option");
        option.value = grade;
        option.textContent = grade;
        classListGradeSelect.appendChild(option);
    });
});

// Function to generate class list tables with print button
function generateClassList(selectedGrade) {
    onValue(learnersRef, (snapshot) => {
        const boys = [];
        const girls = [];

        snapshot.forEach(childSnapshot => {
            const learner = childSnapshot.val();
            if (learner.grade === selectedGrade) {
                if (learner.gender.toLowerCase() === "male") {
                    boys.push(learner.name);
                } else if (learner.gender.toLowerCase() === "female") {
                    girls.push(learner.name);
                }
            }
        });

        let html = `
        <h3 style="text-align:center;">Class List - ${selectedGrade}</h3>
        <button class="print-button" onclick="printClassList()">Print Class List</button>
        <div style="display: flex; gap: 30px; margin-top: 20px;">
            <div style="flex:1;">
                <h4>Boys</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead><tr><th style="border: 1px solid black; padding: 8px;">No.</th><th style="border: 1px solid black; padding: 8px;">Name</th></tr></thead>
                    <tbody>
                        ${boys.map((name, index) => `<tr><td style="border: 1px solid black; padding: 8px;">${index + 1}</td><td style="border: 1px solid black; padding: 8px;">${name}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
            <div style="flex:1;">
                <h4>Girls</h4>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead><tr><th style="border: 1px solid black; padding: 8px;">No.</th><th style="border: 1px solid black; padding: 8px;">Name</th></tr></thead>
                    <tbody>
                        ${girls.map((name, index) => `<tr><td style="border: 1px solid black; padding: 8px;">${index + 1}</td><td style="border: 1px solid black; padding: 8px;">${name}</td></tr>`).join('')}
                    </tbody>
                </table>
            </div>
        </div>`;

        document.getElementById("classListOutput").innerHTML = html;
    });
}

// ? Enhanced print function with school header and logo
window.printClassList = function() {
    const content = document.getElementById("classListOutput").innerHTML;
    const selectedGrade = document.getElementById("classListGradeSelect").value;
    const year = new Date().getFullYear();
    const logoUrl = "https://i.imgur.com/UW65hfv.png"; // Replace if you have a different logo URL

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Class List - ${selectedGrade}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                    th, td { border: 1px solid black; padding: 8px; text-align: left; }
                    h3, h4 { text-align: center; }
                    button { display: none; }
                    .header { text-align: center; margin-bottom: 10px; }
                    .header img { height: 80px; margin-bottom: 5px; }
                    .header h2, .header p { margin: 2px 0; }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="${logoUrl}" alt="School Logo">
                    <h2>NACHU JUNIOR SCHOOL</h2>
                    <p>PO BOX 562-00902 KIKUYU</p>
                    <h3>Learner List</h3>
                    <h4>${selectedGrade} - ${year}</h4>
                </div>
                ${content}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
};
// Button click event listener
document.getElementById("generateClassListBtn").addEventListener("click", () => {
  const selectedGrade = document.getElementById("classListGradeSelect").value;
  if (!selectedGrade) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select a grade.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generateClassList(selectedGrade);
});

document.getElementById("generateParentsListBtn").addEventListener("click", () => {
    const selectedGrade = document.getElementById("filterGrade").value;
    if (!selectedGrade) {
        showToast("Please select a grade from the dropdown to generate the parents list.", "error");
        return;
    }


    const currentYear = new Date().getFullYear();

    // Collect learners data from the table for the selected grade
    const parents = [];
    document.querySelectorAll("#learnersList tr").forEach(row => {
        if (row.getAttribute("data-grade") === selectedGrade) {
            const learnerName = row.cells[2].textContent;
            const parentName = row.cells[6].textContent;
            const phone = row.cells[7].textContent;
            parents.push({ parentName, learnerName, phone });
        }
    });

    // Build printable table
    const tableHtml = `
        <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
            <thead>
                <tr>
                    <th style="border: 1px solid black; padding: 8px;">No.</th>
                    <th style="border: 1px solid black; padding: 8px;">Parent Name</th>
                    <th style="border: 1px solid black; padding: 8px;">Learner Name</th>
                    <th style="border: 1px solid black; padding: 8px;">Phone Number</th>
                    <th style="border: 1px solid black; padding: 8px;">Signature</th>
                </tr>
            </thead>
            <tbody>
                ${parents.map((p, i) => `
                    <tr>
                        <td style="border: 1px solid black; padding: 8px;">${i + 1}</td>
                        <td style="border: 1px solid black; padding: 8px;">${p.parentName}</td>
                        <td style="border: 1px solid black; padding: 8px;">${p.learnerName}</td>
                        <td style="border: 1px solid black; padding: 8px;">${p.phone}</td>
                        <td style="border: 1px solid black; padding: 8px;">&nbsp;</td>
                    </tr>
                `).join("")}
            </tbody>
        </table>
    `;

    // Build printable header
    const headerHtml = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="school-logo.png" alt="School Logo" style="height: 80px; margin-bottom: 10px;"><br>
            <strong style="font-size: 22px;">NACHU PRIMARY AND JUNIOR  SCHOOL</strong><br>
            <strong style="font-size: 20px;">PARENTS ATTENDANCE REGISTER</strong><br>
            <div style="margin-top: 5px; font-size: 14px;">
                ADDRESS: PO BOX 561-00902 KIKUYU, KENYA<br>
                Phone: +254-700-123456<br>
                School Motto: <em>"HARD WORK PAYS"</em><br>
                Year: ${currentYear} / GRADE: <strong>${selectedGrade}</strong>
            </div>
        </div>
    `;

    // Open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Parents List - ${selectedGrade}</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
            </style>
        </head>
        <body>
            ${headerHtml}
            ${tableHtml}
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
});

document.getElementById("groupByPathwaysBtn").addEventListener("click", () => {
  const grade = document.getElementById("reportGradeSelect").value;
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!grade || grade === "Select Grade") {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select a grade.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  if (!examPeriod || examPeriod === "Select Exam Period") {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select an exam period.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generatePathwayGrouping(grade, examPeriod);
});


function generatePathwayGrouping(selectedGrade, selectedExamPeriod) {
    const pathways = {
        STEM: ['eng', 'math', 'preTech', 'kiswahili', 'science', 'agriculture'],
        SocialSciences: ['kiswahili', 'eng', 'social', 'cre'],
        SportsScience: ['kiswahili', 'eng', 'creativeArt']
    };

    const subjectMap = {
        'eng': 3, 'math': 5, 'preTech': 7, 'kiswahili': 9,
        'science': 11, 'social': 13, 'agriculture': 15,
        'cre': 17, 'creativeArt': 19
    };

    const learners = [];
    const summary = { STEM: 0, 'Social Sciences': 0, 'Sports Science': 0 };

    marksTableBody.querySelectorAll("tr").forEach(row => {
        if (selectedGrade && row.getAttribute("data-grade") !== selectedGrade) return;
        if (selectedExamPeriod && row.getAttribute("data-exam-period") !== selectedExamPeriod) return;

        const name = row.cells[1].textContent;
        const grade = row.cells[2].textContent;

        const getScores = (keys) => keys.map(k => parseFloat(row.cells[subjectMap[k]].textContent) || 0);

        const stemScores = getScores(pathways.STEM);
        const socialScores = getScores(pathways.SocialSciences);
        const sportsScores = getScores(pathways.SportsScience);

        const avg = (scores) => (scores.reduce((a, b) => a + b, 0) / scores.length).toFixed(2);

        const stemAvg = avg(stemScores);
        const socialAvg = avg(socialScores);
        const sportsAvg = avg(sportsScores);

        const averages = { STEM: stemAvg, 'Social Sciences': socialAvg, 'Sports Science': sportsAvg };
        const bestPathway = Object.keys(averages).reduce((a, b) => averages[a] > averages[b] ? a : b);

        summary[bestPathway]++;

        learners.push({
            name, grade,
            stemScores, socialScores, sportsScores,
            stemAvg, socialAvg, sportsAvg,
            bestPathway
        });
    });

    const year = new Date().getFullYear();

    // Header
    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; width: 80px; height: 80px;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL PATHWAY REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">Phone: +254-700-123456</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade || 'All'} | Period: ${selectedExamPeriod || 'All'}</p>
        </div>`;

    html += `<h3 style="text-align:center;">Career Pathway Report - Grade ${selectedGrade || 'All'}</h3>`;
    html += `<table style="width:100%; border-collapse: collapse; margin-top:10px;">
        <thead>
            <tr>
                <th style="border:1px solid #000; padding:6px;">No.</th>
                <th style="border:1px solid #000; padding:6px;">Name</th>
                <th style="border:1px solid #000; padding:6px;">Grade</th>
                ${pathways.STEM.map(s => `<th style="border:1px solid #000; padding:6px;">${s.toUpperCase()}</th>`).join('')}
                <th style="border:1px solid #000; padding:6px;">STEM Avg</th>
                ${pathways.SocialSciences.map(s => `<th style="border:1px solid #000; padding:6px;">${s.toUpperCase()}</th>`).join('')}
                <th style="border:1px solid #000; padding:6px;">Social Sciences Avg</th>
                ${pathways.SportsScience.map(s => `<th style="border:1px solid #000; padding:6px;">${s.toUpperCase()}</th>`).join('')}
                <th style="border:1px solid #000; padding:6px;">Sports Science Avg</th>
                <th style="border:1px solid #000; padding:6px;">Best Pathway</th>
            </tr>
        </thead><tbody>`;

    learners.forEach((learner, i) => {
        html += `<tr>
            <td style="border:1px solid #000; padding:6px;">${i + 1}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.name}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.grade}</td>
            ${learner.stemScores.map(score => `<td style="border:1px solid #000; padding:6px;">${score}</td>`).join('')}
            <td style="border:1px solid #000; padding:6px;">${learner.stemAvg}</td>
            ${learner.socialScores.map(score => `<td style="border:1px solid #000; padding:6px;">${score}</td>`).join('')}
            <td style="border:1px solid #000; padding:6px;">${learner.socialAvg}</td>
            ${learner.sportsScores.map(score => `<td style="border:1px solid #000; padding:6px;">${score}</td>`).join('')}
            <td style="border:1px solid #000; padding:6px;">${learner.sportsAvg}</td>
            <td style="border:1px solid #000; padding:6px;">${learner.bestPathway}</td>
        </tr>`;
    });

    html += `</tbody></table>`;

    // Summary Table
    html += `<h4 style="margin-top:20px;">Pathway Summary</h4>`;
    html += `<table style="width:50%; border-collapse: collapse; margin-top:5px;">
        <thead>
            <tr>
                <th style="border:1px solid #000; padding:6px;">Pathway</th>
                <th style="border:1px solid #000; padding:6px;">Number of Learners</th>
            </tr>
        </thead>
        <tbody>
            <tr><td style="border:1px solid #000; padding:6px;">STEM</td><td style="border:1px solid #000; padding:6px;">${summary.STEM}</td></tr>
            <tr><td style="border:1px solid #000; padding:6px;">Social Sciences</td><td style="border:1px solid #000; padding:6px;">${summary['Social Sciences']}</td></tr>
            <tr><td style="border:1px solid #000; padding:6px;">Sports Science</td><td style="border:1px solid #000; padding:6px;">${summary['Sports Science']}</td></tr>
        </tbody>
    </table>`;

    const reportOutput = document.getElementById("reportOutput");
    reportOutput.innerHTML = html;

    // Add a print button dynamically
    let printButton = document.getElementById("printPathwayGroupingBtn");
    if (!printButton) {
        printButton = document.createElement("button");
        printButton.id = "printPathwayGroupingBtn";
        printButton.className = "print-button";
        printButton.innerHTML = '<i class="fas fa-print"></i> Print Report';
        reportOutput.appendChild(printButton);

        printButton.addEventListener("click", () => {
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Pathway Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            table, th, td { border: 1px solid black; padding: 8px; }
                            th { background-color: #f4f4f4; }
                            img { max-width: 100px; }
                        </style>
                    </head>
                    <body>
                        ${reportOutput.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        });
    }
}

document.addEventListener("DOMContentLoaded", function () {
  // Hide both sections on page load
  document.getElementById("classListSection").style.display = "none";
  document.getElementById("recordMarksSection").style.display = "none";
  document.getElementById("performanceReportsSection").style.display = "none";

  // Toggle Class List Section
  document.getElementById("toggleClassListSectionBtn").addEventListener("click", () => {
    const section = document.getElementById("classListSection");
    section.style.display = section.style.display === "none" ? "block" : "none";
  });

  // Toggle Record Marks Section
  document.getElementById("toggleMarksSectionBtn").addEventListener("click", () => {
    const section = document.getElementById("recordMarksSection");
    section.style.display = section.style.display === "none" ? "block" : "none";
  });

  // Toggle Performance Reports Section
  document.getElementById("togglePerformanceReportsBtn").addEventListener("click", () => {
    const section = document.getElementById("performanceReportsSection");
    const icon = document.querySelector("#togglePerformanceReportsBtn i");

    const isHidden = section.style.display === "none";
    section.style.display = isHidden ? "block" : "none";

    // Toggle icon between down and up chevron
    icon.className = isHidden ? "fas fa-chevron-up" : "fas fa-chevron-down";
  });
  
  // Marks Section Toggle with icon update
  const toggleMarksBtn = document.getElementById("toggleMarksSectionBtn");
  const marksSection = document.getElementById("marksSection");
  const icon = toggleMarksBtn.querySelector("i");

  toggleMarksBtn.addEventListener("click", () => {
    const isHidden = marksSection.style.display === "none";
    
    // Toggle display style
    marksSection.style.display = isHidden ? "block" : "none";
    
    // Toggle icon between down and up chevron
    icon.classList.toggle("fa-chevron-down", !isHidden);
    icon.classList.toggle("fa-chevron-up", isHidden);
  });
});
const toggleBtn = document.getElementById('toggleFormBtn');
  const formContainer = document.getElementById('registrationContainer');

  toggleBtn.addEventListener('click', () => {
    const isHidden = formContainer.style.display === 'none';
    // toggle visibility
    formContainer.style.display = isHidden ? 'block' : 'none';
    // update button text
    toggleBtn.textContent = isHidden ? ' Registration ' : ' Registration';
  });
const toggleTableBtn = document.getElementById('toggleTableBtn');
  const tableContainer  = document.getElementById('tableContainer');

  toggleTableBtn.addEventListener('click', () => {
    const hidden = tableContainer.style.display === 'none';
    tableContainer.style.display = hidden ? 'block' : 'none';
    toggleTableBtn.textContent = hidden
      ? ' Registered Learners'
      : 'Registered Learners';
  });
const masterBtn = document.getElementById('masterToggleBtn');
const wrapper = document.getElementById('learnersButtons');
const otherWrapper = document.getElementById('reportsControls');
const otherBtn = document.getElementById('masterReportsBtn');

// Toggle for Learners Database
masterBtn.addEventListener('click', () => {
  const hidden = wrapper.style.display === 'none';

  // Toggle this one
  wrapper.style.display = hidden ? 'block' : 'none';
  masterBtn.textContent = hidden ? ' Learners Database' : 'Learners Database';
  masterBtn.insertAdjacentHTML(
    'afterbegin',
    '<i class="fas fa-database" style="margin-right: 8px; font-size: 1.2em;"></i>'
  );

  // Hide the other one
  otherWrapper.style.display = 'none';
  const otherLabel = otherBtn.querySelector('.btn-label');
  if (otherLabel) otherLabel.textContent = 'Exam & Marks Controls';
});

/**
 * Sets up a show/hide toggle.
 * @param {string} masterBtnId   ID of the toggle button
 * @param {string} wrapperId   ID of the element to show/hide
 * @param {string} showText   Text to show when collapsed
 * @param {string} hideText   Text to show when expanded
 */
function setupToggle(masterBtnId, wrapperId, showText, hideText) {
  const btn = document.getElementById(masterBtnId);
  const wrapper = document.getElementById(wrapperId);
  const label = btn.querySelector('.btn-label');

  // Ensure wrapper starts hidden
  wrapper.style.display = wrapper.style.display || 'none';

  btn.addEventListener('click', () => {
    const isHidden = wrapper.style.display === 'none';
    // Toggle visibility
    wrapper.style.display = isHidden ? 'block' : 'none';
    label.textContent = isHidden ? hideText : showText;

    // Also hide the other section if open
    if (wrapperId === 'reportsControls') {
      document.getElementById('learnersButtons').style.display = 'none';
      document.getElementById('masterToggleBtn').textContent = ' Learners Database';
      document.getElementById('masterToggleBtn').insertAdjacentHTML(
        'afterbegin',
        '<i class="fas fa-database" style="margin-right: 8px; font-size: 1.2em;"></i>'
      );
    }
  });
}

// Wire up your Reports controls
setupToggle(
  'masterReportsBtn',
  'reportsControls',
  'Exam & Marks Controls',
  'Hide Exam & Marks Controls'
);
 // Default login values
  let validUsername = "admin";
  let validPassword = "1";

  document.getElementById("loginForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const user = document.getElementById("username").value.trim();
    const pass = document.getElementById("password").value.trim();

    if (user === validUsername && pass === validPassword) {
      document.getElementById("loginSection").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
    } else {
      document.getElementById("loginError").style.display = "block";
    }
  });

  function showResetPasswordForm() {
    alert("Reset password feature coming soon.");
  }

document.getElementById("printFilteredMarksBtn").addEventListener("click", () => {
    const visibleRows = Array.from(document.querySelectorAll("#marksList tr"))
        .filter(row => row.style.display !== "none");

    if (visibleRows.length === 0) {
        alert("No marks to print. Please adjust your filters.");
        return;
    }

    const selectedGrade = document.getElementById("filterMarksGrade").value || "All";
    const year = new Date().getFullYear();
    const term = document.getElementById("term")?.value || "Term 1";

    // Extract clean row data excluding the last column (Delete button)
    const cleanedRows = visibleRows.map(row => {
        const cells = Array.from(row.cells).slice(0, row.cells.length - 1); // Remove last <td>
        return `<tr>${cells.map(cell => `<td>${cell.innerHTML}</td>`).join("")}</tr>`;
    });

    const tableHtml = `
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>No.</th>
                    <th>Name</th>
                    <th>Grade</th>
                    <th>Eng</th><th>Lev</th>
                    <th>Math</th><th>Lev</th>
                    <th>Pre-Tech</th><th>Lev</th>
                    <th>Kisw</th><th>Lev</th>
                    <th>Scie</th><th>Lev</th>
                    <th>Social</th><th>Lev</th>
                    <th>Agric</th><th>Lev</th>
                    <th>CRE</th><th>Lev</th>
                    <th>C/A</th><th>Lev</th>
                    <th>Total Marks</th>
                </tr>
            </thead>
            <tbody>
                ${cleanedRows.join("")}
            </tbody>
        </table>
    `;

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Filtered Marks Report</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    table { width: 100%; border-collapse: collapse; font-size: 16px; }
                    th, td {
                        border: 2px solid black;
                        padding: 6px;
                        text-align: center;
                    }
                    th {
                        background-color: #f0f0f0;
                        font-weight: bold;
                    }
                    .header {
                        text-align: center;
                        margin-bottom: 20px;
                    }
                    .header img {
                        max-width: 80px;
                        margin-bottom: 10px;
                    }
                </style>
            </head>
            <body>
                <div class="header">
                     <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">                 
                      <h2>NACHU JUNIOR SCHOOL</h2>
                    <p><em>My Talent My Passion</em></p>
                    <p><strong>Term:</strong> ${term} &nbsp;&nbsp; <strong>Grade:</strong> ${selectedGrade} &nbsp;&nbsp; <strong>Year:</strong> ${year}</p>
                </div>
                ${tableHtml}
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
});

function printAssessmentReport() {
    const reportContainer = document.getElementById("assessmentReportsContainer");

    if (!reportContainer || !reportContainer.innerHTML.trim()) {
        showToast("No assessment report available to print.", "error");
        return;
    }

    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
        <html>
            <head>
                <title>Assessment Report</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        margin: 20px;
                        color: #333;
                    }
                    table {
                        width: 100%;
                        border-collapse: collapse;
                        margin-top: 15px;
                    }
                    th, td {
                        border: 1px solid #000;
                        padding: 8px;
                        text-align: center;
                    }
                    th {
                        background-color: #007bff;
                        color: #fff;
                    }
                    td {
                        background-color: #f9f9f9;
                    }
                </style>
            </head>
            <body>
                <div>
                    ${reportContainer.innerHTML}
                </div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}


// Attach event listener to the print button
document.getElementById("printAssessmentReportBtn").addEventListener("click", printAssessmentReport);
function toggleSpinner(show) {
    document.getElementById("spinner").style.display = show ? "block" : "none";
}
// Function to show a custom alert
function showCustomAlert(message, backgroundColor, textColor) {
    // Check if an alert already exists and remove it
    let existingAlert = document.getElementById("custom-alert");
    if (existingAlert) existingAlert.remove();

    // Create a new alert div
    const alertDiv = document.createElement("div");
    alertDiv.id = "custom-alert";
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: ${backgroundColor};
        color: ${textColor};
        padding: 15px 20px;
        border-radius: 5px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        font-size: 16px;
        z-index: 1000;
    `;
    alertDiv.textContent = message;

    // Append the alert to the body
    document.body.appendChild(alertDiv);

    // Automatically remove the alert after 3 seconds
    setTimeout(() => {
        alertDiv.remove();
    }, 3000);
}

// Function to validate the score format and enforce rules
function validateScoreFormat(input) {
    const value = input.value.trim(); // Get the trimmed value
    const integerRegex = /^(?:[1-9][0-9]?|100)$/; // Match integers 1-100 without leading zeros

    if (!integerRegex.test(value)) {
        // Show a custom alert with colors
        showCustomAlert(
            " Invalid score! Please enter a whole number between 1 and 100 without leading zeros or decimals.",
            "#f8d7da", // Light red background
            "#721c24"  // Dark red text
        );
        input.value = ""; // Clear the invalid input
        input.focus(); // Refocus the input field
    }
}

// Attach the validation function to all input fields for marks
document.querySelectorAll('#marksInputs input[type="number"]').forEach(input => {
    // Validate when the user leaves the input field
    input.addEventListener('blur', () => validateScoreFormat(input));
});
function countMarksStatusPerGrade() {
    const gradeCounts = {}; // { grade: { recorded: n, notRecorded: m, notRecordedNames: [] } }

    onValue(learnersRef, (snapshot) => {
        for (const key in gradeCounts) delete gradeCounts[key];

        snapshot.forEach(childSnapshot => {
            const learner = childSnapshot.val();
            const grade = learner.grade || "Unknown";
            const hasMarks = childSnapshot.child("marks").exists();

            if (!gradeCounts[grade]) {
                gradeCounts[grade] = { recorded: 0, notRecorded: 0, notRecordedNames: [] };
            }

            if (hasMarks) {
                gradeCounts[grade].recorded++;
            } else {
                gradeCounts[grade].notRecorded++;
                gradeCounts[grade].notRecordedNames.push(learner.name || "Unknown");
            }
        });

        // Build table HTML with thick 3px borders and black text
        let html = `
            <h3 style="color: black;">Marks Recording Summary Per Grade</h3>
            <table id="marksSummaryTable" style="width: 100%; border-collapse: collapse; margin-top: 10px; color: black;">
                <thead>
                    <tr style="background-color: #007bff; color: white;">
                        <th style="border: 3px solid black; padding: 8px; color: black;">#</th>
                        <th style="border: 3px solid black; padding: 8px; color: black;">Grade</th>
                        <th style="border: 3px solid black; padding: 8px; color: black;">Number of Learners</th>
                        <th style="border: 3px solid black; padding: 8px; color: black;">Recorded Marks</th>
                        <th style="border: 3px solid black; padding: 8px; color: black;">Not Recorded</th>
                        <th style="border: 3px solid black; padding: 8px; color: black;">Learners with No Marks</th>
                        <th style="border: 3px solid black; padding: 8px; color: black;">Remarks</th>
                    </tr>
                </thead>
                <tbody>
        `;

        let gradeCounter = 1; // Counter for numbering grades

        for (const [grade, counts] of Object.entries(gradeCounts)) {
            const total = counts.recorded + counts.notRecorded;
            const learnersWithNoMarks = counts.notRecordedNames.join(", ") || "None";
            let remarks = "";

            if (counts.notRecorded === 0) {
                remarks = "All marks recorded";
            } else if (counts.recorded === 0) {
                remarks = "No marks recorded";
            } else {
                remarks = "Partial marks recorded";
            }

            html += `
                <tr>
                    <td style="border: 3px solid black; padding: 8px; text-align: center; color: black;">${gradeCounter++}</td>
                    <td style="border: 3px solid black; padding: 8px; text-align: center; color: black;">${grade}</td>
                    <td style="border: 3px solid black; padding: 8px; text-align: center; color: black;">${total}</td>
                    <td style="border: 3px solid black; padding: 8px; text-align: center; color: black;">${counts.recorded}</td>
                    <td style="border: 3px solid black; padding: 8px; text-align: center; color: black;">${counts.notRecorded}</td>
                    <td style="border: 3px solid black; padding: 8px; text-align: center; color: black;">${learnersWithNoMarks}</td>
                    <td style="border: 3px solid black; padding: 8px; text-align: center; color: black;">${remarks}</td>
                </tr>
            `;
        }

        html += "</tbody></table>";

        // Add print button
        html += `
            <button id="printMarksSummaryBtn" style="margin-top: 15px; padding: 10px 20px; background-color: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer;">
                <i class="fas fa-print"></i> Print Report
            </button>
        `;

        const container = document.getElementById("marksStatusSummary");
        container.innerHTML = html;

        document.getElementById("printMarksSummaryBtn").addEventListener("click", () => {
            const logoUrl = "https://i.imgur.com/2bSAbwq.jpeg"; // Your school logo URL
            const year = new Date().getFullYear();
            const tableHTML = document.getElementById("marksSummaryTable").outerHTML;

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>NACHU JUNIOR SCHOOL MARKS CAPTURE Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; color: black; }
                        h2, p { text-align: center; margin: 5px 0; color: black; }
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; color: black; }
                        th, td { border: 3px solid black; padding: 8px; text-align: center; color: black; }
                        th { background-color: #007bff; color: white; }
                        img.logo { display: block; margin: 0 auto 15px; width: 100px; }

                        .stamp {
                            border: 2px solid blue;
                            color: blue;
                            text-align: center;
                            width: 200px;
                            height: 70px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            margin: 10px auto;
                            font-weight: bold;
                        }
                    </style>
                </head>
                <body>
                    <img src="${logoUrl}" alt="School Logo" class="logo">
                    <h2>NACHU JUNIOR SCHOOL MARKS CAPTURE Report</h2>
                    <p>ADDRESS: P.O. BOX 561-00902 Kikuyu KENYA</p>
                    <p>School Motto: "Excellence Through Knowledge"</p>
                    <p>Year: ${year}</p>
                    ${tableHTML}

                    <div class="stamp">
                        Nachu Junior School<br>
                        Po Box 561-00902<br>
                        Kikuyu...Exam Department
                    </div>
                </body>
                </html>
            `);

            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        });
    });
}


document.getElementById("showMarksStatusBtn").addEventListener("click", () => {
    const summaryDiv = document.getElementById("marksStatusSummary");
    const toggleButton = document.getElementById("showMarksStatusBtn");
    const toggleIcon = document.getElementById("toggleIcon");

    // Toggle visibility
    if (summaryDiv.style.display === "none" || !summaryDiv.style.display) {
        countMarksStatusPerGrade(); // Generate the summary table
        summaryDiv.style.display = "block"; // Show the summary
        toggleButton.textContent = " Hide Marks Recording Status Per Grade"; // Update button text
        toggleButton.prepend(toggleIcon); // Keep icon on the left
        toggleIcon.className = "fas fa-eye-slash"; // Change icon to 'eye-slash'
    } else {
        summaryDiv.style.display = "none"; // Hide the summary
        toggleButton.textContent = " Show Marks Recording Status Per Grade"; // Update button text
        toggleButton.prepend(toggleIcon); // Keep icon on the left
        toggleIcon.className = "fas fa-eye"; // Change icon back to 'eye'
    }
});

// Populate grade dropdown from registered learners in Firebase
function populateMeritGradeSelect() {
    const gradeDropdown = document.getElementById("meritGradeSelect");
    const gradesSet = new Set();

    onValue(learnersRef, (snapshot) => {
        snapshot.forEach(child => {
            const learner = child.val();
            if (learner.grade) {
                gradesSet.add(learner.grade.trim());
            }
        });

        gradeDropdown.innerHTML = '<option value="">Select Grade</option>';
        Array.from(gradesSet).sort().forEach(grade => {
            const option = document.createElement("option");
            option.value = grade;
            option.textContent = grade;
            gradeDropdown.appendChild(option);
        });
    }, { onlyOnce: true });
}

// Run once when page loads
window.addEventListener('load', populateMeritGradeSelect);

// Updated event listener to use new dropdown
document.getElementById("generateBlankMeritBtn").addEventListener("click", () => {
    const selectedGrade = document.getElementById("meritGradeSelect").value;

    if (!selectedGrade) {
        showCustomAlert("Please select a grade first.");
        return;
    }

    onValue(learnersRef, (snapshot) => {
        generateBlankMeritLists(snapshot, selectedGrade);
    }, { onlyOnce: true });
});
function generateBlankMeritLists(learnersSnapshot, selectedGrade) {
    const container = document.createElement("div");
    container.style.marginTop = "20px";
    container.id = "blankMeritOutput";

    const learners = [];

    learnersSnapshot.forEach(childSnapshot => {
        const learner = childSnapshot.val();
        if (learner.grade === selectedGrade) {
            learners.push(learner);
        }
    });

    if (learners.length === 0) {
        container.innerHTML = `<h2>Blank Merit List for Grade ${selectedGrade}</h2><p>No learners found.</p>`;
        document.getElementById("reportOutput").innerHTML = "";
        document.getElementById("reportOutput").appendChild(container);
        return;
    }

    const term = "Term 1";
    const year = new Date().getFullYear();
    const schoolName = "NACHU JUNIOR SCHOOL";
    const logoUrl = "https://i.imgur.com/2bSAbwq.jpeg";

    // Print Button
    const printButton = document.createElement("button");
    printButton.className = "print-button";
    printButton.style.marginBottom = "10px";
    printButton.style.float = "right";
    printButton.innerHTML = `<i class="fas fa-print"></i> Print Merit List`;
    printButton.onclick = () => {
        const tableHTML = container.querySelector("table").outerHTML;

        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <html>
                <head>
                    <title>Blank Merit List - ${selectedGrade}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; text-align: center; }
                        img { width: 80px; height: auto; margin-bottom: 10px; }
                        table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                        th, td { border: 1px solid #000; padding: 8px; text-align: center; }
                        caption { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                        .header-section p { margin: 4px 0; }
                    </style>
                </head>
                <body>
                    <img src="${logoUrl}" alt="School Logo">
                    <div class="header-section">
                        <h2>${schoolName}</h2>
                        <p><strong>Grade:</strong> ${selectedGrade}</p>
                        <p><strong>Term:</strong> ${term} &nbsp;&nbsp;&nbsp;&nbsp; <strong>Year:</strong> ${year}</p>
                    </div>
                    ${tableHTML}
                </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    };
    container.appendChild(printButton);

    // Subjects
    const subjects = [
        'Eng', 'Math', 'Pre-Tech', 'Kisw', 'Scie',
        'Sst', 'Agric', 'Cre', 'C/A'
    ];

    const table = document.createElement("table");

    // Header row: Subject and generic 'Level' column beside it
    const headerRow = `<tr>
        <th>No.</th>
        <th>Name</th>
        ${subjects.map(subject => `<th>${subject}</th><th>Level</th>`).join('')}
    </tr>`;

    // Data Rows
    const bodyRows = learners.map((learner, index) => `
        <tr>
            <td>${index + 1}</td>
            <td>${learner.name}</td>
            ${subjects.map(() => `<td></td><td></td>`).join('')}
        </tr>
    `).join('');

    table.innerHTML = `
        <caption>Grade ${selectedGrade} - Blank Merit List</caption>
        <thead>
            ${headerRow}
        </thead>
        <tbody>
            ${bodyRows}
        </tbody>
    `;

    container.appendChild(table);

    document.getElementById("reportOutput").innerHTML = "";
    document.getElementById("reportOutput").appendChild(container);
}
document.getElementById("generateSubjectRankBtn").addEventListener("click", () => {
  const selectedGrade = document.getElementById("reportGradeSelect").value;
  const selectedPeriod = document.getElementById("reportExamPeriodSelect").value;
  const selectedSubject = document.getElementById("rankingSubjectSelect").value;

  if (!selectedGrade || !selectedPeriod || !selectedSubject) {
    showToast("Please select a grade, exam period, and subject.", "error");
    return;
  }

  generateSubjectRanking(selectedGrade, selectedSubject, selectedPeriod);
});
function generateSubjectRanking(grade, subjectKey, period) {
  const subjectNames = {
    eng: "English",
    math: "Mathematics",
    preTech: "Pre-Technical Studies",
    kiswahili: "Kiswahili",
    science: "Integrated Science",
    social: "Social Studies",
    agriculture: "Agriculture",
    cre: "Religious Education",
    creativeArt: "Creative Art"
  };

  function getLevel(score) {
    if (score >= 90) return "EE 1";
    if (score >= 75) return "EE 2";
    if (score >= 58) return "ME 1";
    if (score >= 41) return "ME 2";
    if (score >= 31) return "AE 1";
    if (score >= 21) return "AE 2";
    if (score >= 11) return "BE 1";
    return "BE 2";
  }

  const learners = [];

  document.querySelectorAll("#marksList tr").forEach(row => {
    if (row.getAttribute("data-grade") !== grade) return;
    if (row.getAttribute("data-exam-period") !== period) return;

    const learnerName = row.cells[1].textContent;
    const subjectColIndex = {
      eng: 3, math: 5, preTech: 7, kiswahili: 9, science: 11,
      social: 13, agriculture: 15, cre: 17, creativeArt: 19
    }[subjectKey];

    const score = parseFloat(row.cells[subjectColIndex].textContent) || 0;
    const level = getLevel(score);
    learners.push({ name: learnerName, score, level });
  });

  learners.sort((a, b) => b.score - a.score);

  const year = new Date().getFullYear();

  let html = `
    <div style="text-align: center; margin-bottom: 20px;">
      <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
      <h2 style="margin: 0;">NACHU JUNIOR SCHOOL SUBJECT RANKING REPORT</h2>
      <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
      <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
      <p style="margin: 5px 0;">Year: ${year}</p>
      <p style="margin: 5px 0;">Grade: ${grade}</p>
      <p style="margin: 5px 0;">Exam Period: ${period}</p>
    </div>

    <table style="width:100%; border-collapse: collapse; margin-top: 15px; background-color: white; color: black; font-size: 16px;">
      <thead>
        <tr style="background: #f2f2f2;">
          <th style="border: 1px solid black; padding: 10px;">Rank</th>
          <th style="border: 1px solid black; padding: 10px;">Name</th>
          <th style="border: 1px solid black; padding: 10px;">Score</th>
          <th style="border: 1px solid black; padding: 10px;">Performance Level</th>
        </tr>
      </thead>
      <tbody>`;

  learners.forEach((learner, index) => {
    html += `
      <tr>
        <td style="border: 1px solid black; padding: 10px;">${index + 1}</td>
        <td style="border: 1px solid black; padding: 10px;">${learner.name}</td>
        <td style="border: 1px solid black; padding: 10px;">${learner.score}</td>
        <td style="border: 1px solid black; padding: 10px;">${learner.level}</td>
      </tr>`;
  });

  html += `
      </tbody>
    </table>

    <div style="text-align:right; margin-top: 20px;">
      <button id="printRankingReportBtn" style="padding: 8px 16px; background: #007BFF; color: #fff; border: none; border-radius: 4px;">Print Report</button>
    </div>`;

  document.getElementById("reportOutput").innerHTML = html;

  // Print logic
  document.getElementById("printRankingReportBtn").addEventListener("click", () => {
    const content = document.getElementById("reportOutput").innerHTML;
    const printWindow = window.open("", "_blank", "width=900,height=650");
    printWindow.document.write(`
      <html>
        <head>
          <title>Subject Ranking Report</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid black; padding: 8px; }
            th { background-color: #f4f4f4; }
            button { display: none; }
            img { max-width: 100px; }
          </style>
        </head>
        <body>${content}</body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  });
}



document.getElementById("loadMarksByPeriodBtn").addEventListener("click", () => {
  const selectedExamPeriod = document.getElementById("marksExamPeriodSelect").value;
  if (!selectedExamPeriod) {
    showToast("Please select an exam period to view marks.", "error");
    return;
  }
  loadMarksTableForPeriod(selectedExamPeriod);
});
function loadMarksTableForPeriod(examPeriod) {
  marksTableBody.innerHTML = "";
  const grades = new Set();
  let index = 1;

  let sums = {
    eng: 0, math: 0, preTech: 0, kiswahili: 0,
    science: 0, social: 0, agriculture: 0, cre: 0, creativeArt: 0, totalMarks: 0
  };

  let learnersWithMarks = 0;

  onValue(learnersRef, (snapshot) => {
    marksTableBody.innerHTML = "";

    snapshot.forEach(childSnapshot => {
      const data = childSnapshot.val();
      const marksData = data.marks || {};
      const marks = marksData[examPeriod] || null;

      if (marks) {
        learnersWithMarks++;

        const rowTotal = 
          (parseFloat(marks.eng) || 0) +
          (parseFloat(marks.math) || 0) +
          (parseFloat(marks.preTech) || 0) +
          (parseFloat(marks.kiswahili) || 0) +
          (parseFloat(marks.science) || 0) +
          (parseFloat(marks.social) || 0) +
          (parseFloat(marks.agriculture) || 0) +
          (parseFloat(marks.cre) || 0) +
          (parseFloat(marks.creativeArt) || 0);

        sums.eng += (parseFloat(marks.eng) || 0);
        sums.math += (parseFloat(marks.math) || 0);
        sums.preTech += (parseFloat(marks.preTech) || 0);
        sums.kiswahili += (parseFloat(marks.kiswahili) || 0);
        sums.science += (parseFloat(marks.science) || 0);
        sums.social += (parseFloat(marks.social) || 0);
        sums.agriculture += (parseFloat(marks.agriculture) || 0);
        sums.cre += (parseFloat(marks.cre) || 0);
        sums.creativeArt += (parseFloat(marks.creativeArt) || 0);
        sums.totalMarks += rowTotal;

        grades.add(data.grade);

      const row = document.createElement("tr");
row.setAttribute("data-grade", data.grade);
row.setAttribute("data-exam-period", examPeriod); //  ADD THIS LINE

row.innerHTML = `
  <td>${index++}</td>
  <td>${data.name}</td>
  <td>${data.grade}</td>
  <td>${marks.eng}</td><td>${marks.engLev}</td>
  <td>${marks.math}</td><td>${marks.mathLev}</td>
  <td>${marks.preTech}</td><td>${marks.preTechLev}</td>
  <td>${marks.kiswahili}</td><td>${marks.kiswahiliLev}</td>
  <td>${marks.science}</td><td>${marks.scienceLev}</td>
  <td>${marks.social}</td><td>${marks.socialLev}</td>
  <td>${marks.agriculture}</td><td>${marks.agricultureLev}</td>
  <td>${marks.cre}</td><td>${marks.creLev}</td>
  <td>${marks.creativeArt}</td><td>${marks.creativeArtLev}</td>
  <td><strong>${rowTotal}</strong></td>
  <td><button class="deleteMarksBtn" data-key="${childSnapshot.key}" data-exam="${examPeriod}">Delete</button></td>
`;

        marksTableBody.appendChild(row);
      }
    });

    // ? Update Totals and Averages in the table footer
    const divisor = learnersWithMarks > 0 ? learnersWithMarks : 1;

    document.getElementById("totalsRow").innerHTML = `
      <td colspan="3"><strong>Totals</strong></td>
      <td>${sums.eng}</td><td></td>
      <td>${sums.math}</td><td></td>
      <td>${sums.preTech}</td><td></td>
      <td>${sums.kiswahili}</td><td></td>
      <td>${sums.science}</td><td></td>
      <td>${sums.social}</td><td></td>
      <td>${sums.agriculture}</td><td></td>
      <td>${sums.cre}</td><td></td>
      <td>${sums.creativeArt}</td><td></td>
      <td><strong>${sums.totalMarks}</strong></td>
      <td></td>
    `;

    document.getElementById("averagesRow").innerHTML = `
      <td colspan="3"><strong>Averages</strong></td>
      <td>${(sums.eng / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.math / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.preTech / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.kiswahili / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.science / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.social / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.agriculture / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.cre / divisor).toFixed(2)}</td><td></td>
      <td>${(sums.creativeArt / divisor).toFixed(2)}</td><td></td>
      <td><strong>${(sums.totalMarks / divisor).toFixed(2)}</strong></td>
      <td></td>
    `;
  });
}



function showToast(message, type = 'info') {
  const toast = document.getElementById("toast");
  toast.className = `toast show ${type}`;
  toast.innerHTML = message;

  setTimeout(() => {
    toast.className = toast.className.replace("show", "");
  }, 3000);
}

document.getElementById("subjectRankingReportBtn").addEventListener("click", () => {
  const grade = document.getElementById("reportGradeSelect").value;
  const examPeriod = document.getElementById("reportExamPeriodSelect").value;

  if (!grade || !examPeriod) {
    Swal.fire({
      toast: true,
      position: 'top-end',
      icon: 'warning',
      title: 'Please select both grade and exam period.',
      showConfirmButton: false,
      timer: 3000,
      timerProgressBar: true
    });
    return;
  }

  generateSubjectRankingPerLearner(grade, examPeriod);
});



function generateSubjectRankingPerLearner(selectedGrade, selectedPeriod) {
    const subjects = [
        'English', 'Mathematics', 'Pre-Technical Studies',
        'Kiswahili', 'Integrated Science', 'Social Studies',
        'Agriculture', 'Religious Education', 'Creative Art'
    ];
    const subjectKeys = [
        'eng', 'math', 'preTech',
        'kiswahili', 'science', 'social',
        'agriculture', 'cre', 'creativeArt'
    ];

    const year = new Date().getFullYear();

    let html = `
        <div style="text-align: center; margin-bottom: 20px;">
            <img src="https://i.imgur.com/2bSAbwq.jpeg" alt="School Logo" style="display: block; margin: 0 auto 10px; max-width: 80px; height: auto;">
            <h2 style="margin: 0;">NACHU JUNIOR SCHOOL SUBJECT RANKING REPORT</h2>
            <p style="margin: 5px 0;">Address: P.O. Box 561-00902, Kikuyu, Kenya</p>
            <p style="margin: 5px 0;">School Motto: "Excellence Through Knowledge"</p>
            <p style="margin: 5px 0;">Year: ${year}</p>
            <p style="margin: 5px 0;">Grade: ${selectedGrade}</p>
            <p style="margin: 5px 0;">Exam Period: ${selectedPeriod}</p>
        </div>

        <table style="width:100%; border-collapse: collapse; margin-top: 15px;">
        <thead>
            <tr style="background-color: #f2f2f2;">
                <th style="border: 1px solid black; padding: 8px;">No.</th>
                <th style="border: 1px solid black; padding: 8px;">Learner Name</th>
                <th style="border: 1px solid black; padding: 8px;">Subject</th>
                <th style="border: 1px solid black; padding: 8px;">Score</th>
                <th style="border: 1px solid black; padding: 8px;">Rank</th>
            </tr>
        </thead>
        <tbody>
    `;

    let learnerCount = 1;

    document.querySelectorAll("#marksList tr").forEach(row => {
        if (row.getAttribute("data-grade") !== selectedGrade) return;
        if (row.getAttribute("data-exam-period") !== selectedPeriod) return;

        const learnerName = row.cells[1].textContent;

        const scores = subjectKeys.map((key, i) => ({
            subject: subjects[i],
            score: parseFloat(row.cells[3 + i * 2].textContent) || 0
        }));

        scores.sort((a, b) => b.score - a.score);

        scores.forEach((entry, idx) => {
            html += `
                <tr>
                    <td style="border: 1px solid black; padding: 8px;">${learnerCount}</td>
                    <td style="border: 1px solid black; padding: 8px;">${learnerName}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.subject}</td>
                    <td style="border: 1px solid black; padding: 8px;">${entry.score}</td>
                    <td style="border: 1px solid black; padding: 8px;">${idx + 1}</td>
                </tr>
            `;
        });

        learnerCount++;
    });

    html += `</tbody></table>`;

    html += `
        <div style="text-align:right; margin-top: 20px;">
            <button id="printLearnerSubjectRankBtn" style="padding: 8px 16px; background: #007BFF; color: white; border: none; border-radius: 4px;">Print Report</button>
        </div>`;

    document.getElementById("reportOutput").innerHTML = html;

    // Add print functionality
    document.getElementById("printLearnerSubjectRankBtn").addEventListener("click", () => {
        const printContent = document.getElementById("reportOutput").innerHTML;
        const printWindow = window.open("", "_blank", "width=900,height=650");

        printWindow.document.write(`
            <html>
                <head>
                    <title>Subject Ranking Report Per Learner</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid black; padding: 8px; text-align: left; }
                        th { background-color: #f2f2f2; }
                        img { max-width: 100px; }
                        button { display: none; }
                    </style>
                </head>
                <body>${printContent}</body>
            </html>
        `);

        printWindow.document.close();
        printWindow.print();
    });
}

 function enableEnterAsTab(containerSelector) {
    const container = document.querySelector(containerSelector);
    if (!container) return;

    container.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault(); // Prevent Enter from triggering default behavior

        const focusable = Array.from(container.querySelectorAll('input, select, button, [tabindex]'))
          .filter(el => !el.disabled && el.tabIndex >= 0 && el.offsetParent !== null);

        const index = focusable.indexOf(document.activeElement);
        if (index > -1 && index < focusable.length - 1) {
          focusable[index + 1].focus();
        }
      }
    });
  }

  // Enable Enter-as-Tab behavior in these sections
  enableEnterAsTab('#learnerForm');      // Registration form
  enableEnterAsTab('#marksForm');        // Marks form
  enableEnterAsTab('#learnersList');     // Registered Learners table rows



</script>


</body>
</html>
   
